<style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap');
    .nest-title { font-family: 'Playfair Display', serif; color: #1a365d; }
    .nest-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    .nest-modal-content { background: white; margin: 2% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 1000px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .nest-input { border: 1px solid #e2e8f0; padding: 8px 12px; border-radius: 6px; width: 100%; margin-top: 4px; }
    .nest-label { font-size: 0.7rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    .nest-btn { padding: 10px 20px; border-radius: 6px; font-weight: 700; transition: all 0.2s; cursor: pointer; }
</style>

<div class="max-w-6xl mx-auto py-6">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 30px;">
        <h1 class="text-4xl nest-title">Session Details</h1>
        <button onclick="openNestModal()" class="nest-btn bg-[#00d1b2] text-white hover:opacity-90">+ ADD NEW SESSION</button>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-50 border-b border-gray-200">
                    <th class="p-4 nest-label">#</th>
                    <th class="p-4 nest-label">Lessons</th>
                    <th class="p-4 nest-label">Manner Topic</th>
                    <th class="p-4 nest-label" style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="sessionTableBody">
                </tbody>
        </table>
    </div>
</div>

<div id="nestModal" class="nest-modal">
    <div class="nest-modal-content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <h2 id="nestModalTitle" class="text-2xl nest-title">Manage Session</h2>
            <button onclick="closeNestModal()" style="font-size: 24px; color: #94a3b8;">&times;</button>
        </div>
        
        <form id="nestSessionForm">
            <input type="hidden" id="nest_id">
            <div style="display: grid; grid-template-cols: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                <div>
                    <label class="nest-label">Session Num</label>
                    <input type="number" id="nest_num" class="nest-input" required>
                </div>
                <div>
                    <label class="nest-label">Theme Color</label>
                    <input type="text" id="nest_color" placeholder="#FF5733" class="nest-input">
                </div>
                <div>
                    <label class="nest-label">Map Icon URL</label>
                    <input type="text" id="nest_icon" class="nest-input">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <label class="nest-label">Lesson 1</label>
                    <input type="text" id="nest_l1_t" placeholder="Title" class="nest-input mb-2">
                    <select id="nest_l1_c" class="nest-input">
                        <option value="Alphabet">Alphabet</option>
                        <option value="Numbers">Numbers</option>
                        <option value="Motor Skills">Motor Skills</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <label class="nest-label">Lesson 2</label>
                    <input type="text" id="nest_l2_t" placeholder="Title" class="nest-input mb-2">
                    <select id="nest_l2_c" class="nest-input">
                        <option value="Alphabet">Alphabet</option>
                        <option value="Numbers">Numbers</option>
                        <option value="Motor Skills">Motor Skills</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="nest-label">Manner Topic</label>
                <input type="text" id="nest_manner" class="nest-input">
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <div><label class="nest-label">Objective 1</label><input type="text" id="nest_obj1" class="nest-input"></div>
                <div><label class="nest-label">Objective 2</label><input type="text" id="nest_obj2" class="nest-input"></div>
                <div><label class="nest-label">Objective 3</label><input type="text" id="nest_obj3" class="nest-input"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="nest-label">Full Lesson Plan Source</label>
                <textarea id="nest_full" rows="4" class="nest-input"></textarea>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; padding-top: 20px;">
                <button type="button" onclick="closeNestModal()" class="nest-btn bg-gray-100 text-gray-600">Cancel</button>
                <button type="submit" class="nest-btn bg-blue-600 text-white">Save Session</button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const API_URL = "https://x8ki-letl-twmt.n7.xano.io/api:joVisOhQ/session_details";

    window.openNestModal = function() { document.getElementById('nestModal').style.display = 'block'; };
    window.closeNestModal = function() { 
        document.getElementById('nestModal').style.display = 'none'; 
        document.getElementById('nestSessionForm').reset();
        document.getElementById('nest_id').value = '';
    };

    async function loadData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const tbody = document.getElementById('sessionTableBody');
            tbody.innerHTML = data.map(s => `
                <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                    <td class="p-4 font-bold text-gray-500 text-sm">#${s.session_num}</td>
                    <td class="p-4">
                        <div class="text-sm font-bold text-gray-800">${s.lesson_1_title || '---'}</div>
                        <div class="text-xs text-gray-400">${s.lesson_2_title || '---'}</div>
                    </td>
                    <td class="p-4 text-sm text-gray-600 italic">${s.manner_topic || ''}</td>
                    <td class="p-4 text-right">
                        <button onclick="editNest(${s.id})" style="color: blue; font-weight: bold; font-size: 12px; margin-right: 10px;">EDIT</button>
                        <button onclick="deleteNest(${s.id})" style="color: red; font-weight: bold; font-size: 12px;">DEL</button>
                    </td>
                </tr>
            `).join('');
        } catch (e) { console.error("Session Load Error:", e); }
    }

    window.editNest = async function(id) {
        const res = await fetch(\`\${API_URL}/\${id}\`);
        const s = await res.json();
        document.getElementById('nest_id').value = s.id;
        document.getElementById('nest_num').value = s.session_num;
        document.getElementById('nest_l1_t').value = s.lesson_1_title;
        document.getElementById('nest_l1_c').value = s.lesson_1_cat;
        document.getElementById('nest_l2_t').value = s.lesson_2_title;
        document.getElementById('nest_l2_c').value = s.lesson_2_cat;
        document.getElementById('nest_manner').value = s.manner_topic;
        document.getElementById('nest_obj1').value = s.obj_text_1;
        document.getElementById('nest_obj2').value = s.obj_text_2;
        document.getElementById('nest_obj3').value = s.obj_text_3;
        document.getElementById('nest_color').value = s.theme_color;
        document.getElementById('nest_icon').value = s.map_icon_url;
        document.getElementById('nest_full').value = s.full_lesson_plan;
        openNestModal();
    };

    document.getElementById('nestSessionForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('nest_id').value;
        const payload = {
            session_num: parseInt(document.getElementById('nest_num').value),
            lesson_1_title: document.getElementById('nest_l1_t').value,
            lesson_1_cat: document.getElementById('nest_l1_c').value,
            lesson_2_title: document.getElementById('nest_l2_t').value,
            lesson_2_cat: document.getElementById('nest_l2_c').value,
            manner_topic: document.getElementById('nest_manner').value,
            obj_text_1: document.getElementById('nest_obj1').value,
            obj_text_2: document.getElementById('nest_obj2').value,
            obj_text_3: document.getElementById('nest_obj3').value,
            theme_color: document.getElementById('nest_color').value,
            map_icon_url: document.getElementById('nest_icon').value,
            full_lesson_plan: document.getElementById('nest_full').value
        };
        await fetch(id ? \`\${API_URL}/\${id}\` : API_URL, {
            method: id ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        closeNestModal();
        loadData();
    };

    window.deleteNest = async function(id) {
        if(confirm('Delete?')) {
            await fetch(\`\${API_URL}/\${id}\`, {method: 'DELETE'});
            loadData();
        }
    };

    loadData();
})();
</script>
