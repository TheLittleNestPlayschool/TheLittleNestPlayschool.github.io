<div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div style="margin-bottom: 15px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:13px;">1. SCHOOL LOCATION</label>
        <select id="franchiseSelect" onchange="loadLists()" style="width:100%; padding:12px; border-radius:6px; border:1px solid #ddd;">
            <option value="">-- Choose Location --</option>
        </select>
    </div>

    <div style="margin-bottom: 15px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:13px;">2. TEACHER</label>
        <select id="teacherSelect" style="width:100%; padding:12px; border-radius:6px; border:1px solid #ddd;">
            <option value="">-- Select Teacher --</option>
        </select>
    </div>

    <div style="margin-bottom: 15px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:13px;">3. STUDENT</label>
        <select id="studentSelect" style="width:100%; padding:12px; border-radius:6px; border:1px solid #ddd;">
            <option value="">-- Select Student --</option>
        </select>
    </div>

    <div style="margin-bottom: 15px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:13px;">4. SELECT PHOTO/VIDEO</label>
        <input type="file" id="fileInput" accept="image/*,video/*" onchange="doPreview()" style="width:100%;">
        <div id="previewBox" class="preview-box">No file selected</div>
    </div>

    <button id="uploadBtn" onclick="handleUpload()" style="width:100%; background:#1e3a8a; color:white; border:none; padding:15px; border-radius:6px; font-weight:bold; font-size:16px; cursor:pointer;">
        Upload to Vault
    </button>
    
    <div id="status" style="margin-top:15px; font-size:14px; text-align:center; color:#666; font-weight:bold;">Ready.</div>

    <script>
        const X_URL = 'https://x8ki-letl-twmt.n7.xano.io/api:I12II1nL';
        const W_END = 's3.ap-southeast-1.wasabisys.com';
        const BKT = 'the-little-nest-media';
        const AK = 'P7GI5LQMI4OX2SPAV1YA';
        const SK = 'NVDSvPLB6HeLROD9piOwBjeUl45Reeb5zrhPKiLY';

        const s3 = new AWS.S3({ endpoint: W_END, accessKeyId: AK, secretAccessKey: SK, s3ForcePathStyle: true, signatureVersion: 'v4' });

        async function init() {
            try {
                const r = await fetch(`${X_URL}/uploader_get_franchises`);
                const data = await r.json();
                const sel = document.getElementById('franchiseSelect');
                data.forEach(f => { sel.innerHTML += `<option value="${f.id}">${f.name}</option>`; });
            } catch (e) { console.error(e); }
        }

        async function loadLists() {
            const fid = document.getElementById('franchiseSelect').value;
            if(!fid) return;
            document.getElementById('status').innerText = "Updating lists...";
            try {
                const [t, s] = await Promise.all([
                    fetch(`${X_URL}/uploader_get_teachers?franchise_id=${fid}`).then(res => res.json()),
                    fetch(`${X_URL}/uploader_get_students?franchise_id=${fid}`).then(res => res.json())
                ]);
                const tSel = document.getElementById('teacherSelect');
                tSel.innerHTML = '<option value="">-- Select Teacher --</option>';
                t.forEach(item => tSel.innerHTML += `<option value="${item.id}">${item.first_name}</option>`);
                
                const sSel = document.getElementById('studentSelect');
                sSel.innerHTML = '<option value="">-- Select Student --</option>';
                s.forEach(item => sSel.innerHTML += `<option value="${item.id}">${item.name}</option>`);
                
                document.getElementById('status').innerText = "Lists synced.";
            } catch (e) { document.getElementById('status').innerText = "Sync error."; }
        }

        function doPreview() {
            const file = document.getElementById('fileInput').files[0];
            const box = document.getElementById('previewBox');
            if (!file) return;
            if (file.type.startsWith('image/')) {
                const r = new FileReader();
                r.onload = (e) => box.innerHTML = `<img src="${e.target.result}">`;
                r.readAsDataURL(file);
            } else {
                box.innerHTML = "Video selected.";
            }
        }

        async function handleUpload() {
            let file = document.getElementById('fileInput').files[0];
            const fid = document.getElementById('franchiseSelect').value;
            const tid = document.getElementById('teacherSelect').value;
            const sid = document.getElementById('studentSelect').value;

            if (!file || !fid || !tid || !sid) return alert("Fill all fields.");

            const btn = document.getElementById('uploadBtn');
            const st = document.getElementById('status');
            btn.disabled = true;

            try {
                if (file.type.startsWith('image/')) {
                    st.innerText = "Optimizing...";
                    file = await imageCompression(file, { maxSizeMB: 0.8, maxWidthOrHeight: 1600 });
                }

                st.innerText = "Uploading...";
                const key = `vault/franchise_${fid}/student_${sid}/${Date.now()}_${file.name}`;
                const up = await s3.upload({ Bucket: BKT, Key: key, Body: file, ContentType: file.type, ACL: 'public-read' }).promise();

                st.innerText = "Securing record...";
                await fetch(`${X_URL}/uploader_register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        franchise_id: parseInt(fid),
                        student_id: parseInt(sid),
                        teacher_id: parseInt(tid),
                        file_url: up.Location,
                        file_type: file.type.includes('image') ? 'image' : 'video'
                    })
                });

                st.innerText = "Success! Upload secured.";
                document.getElementById('fileInput').value = "";
                document.getElementById('previewBox').innerHTML = "No file selected";
            } catch (e) {
                st.innerText = "Error: " + e.message;
            } finally {
                btn.disabled = false;
            }
        }
        init();
    </script>
</div>
