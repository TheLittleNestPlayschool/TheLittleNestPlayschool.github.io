<div id="setupView">
    <div style="margin-bottom:15px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:12px; color:#475569;">1. SCHOOL LOCATION</label>
        <select id="franchiseSelect" onchange="loadDependencies()">
            <option value="">-- Choose Location --</option>
        </select>
    </div>

    <div id="teacherSection" style="display:none; margin-bottom:15px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:12px; color:#475569;">2. TEACHER NAME</label>
        <select id="teacherSelect">
            <option value="">-- Select Teacher --</option>
        </select>
    </div>

    <div id="filePickerSection" style="display:none; text-align:center; padding:30px 20px; border:2px dashed #cbd5e1; border-radius:12px; background:#f8fafc;">
        <p style="margin-bottom:10px; color:#1e3a8a; font-weight:bold;">3. Select Photos/Videos (Max 20)</p>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple onchange="startQueue()" style="font-size:14px;">
    </div>
</div>

<div id="batchCard" class="card" style="display:none;">
    <div class="preview-area" id="previewContainer">
        </div>
    <div class="form-padding">
        <label style="display:block; font-weight:bold; margin-bottom:5px; font-size:12px; color:#64748b;">4. WHO IS IN THIS PHOTO?</label>
        <select id="studentSelect">
            <option value="">-- Select Student --</option>
        </select>
        <button id="uploadBtn" onclick="queueAndNext()" class="btn-upload">Tag & Next Photo</button>
    </div>
</div>

<div id="finalSummary" class="card" style="display:none; padding:20px;">
    <h3 style="margin-top:0; color:#1e3a8a;">The Little Nest Vault</h3>
    <p style="font-size:14px; color:#64748b;">Processing batch... Wait for green borders before closing.</p>
    <div id="summaryGrid" class="summary-grid"></div>
    <button onclick="location.reload()" class="btn-upload" style="margin-top:20px; background:#64748b;">Start New Batch</button>
</div>

<script>
    const X_BASE = 'https://x8ki-letl-twmt.n7.xano.io/api:I12II1nL';
    const W_END = 's3.ap-southeast-1.wasabisys.com';
    const BKT = 'the-little-nest-media';
    const AK = 'P7GI5LQMI4OX2SPAV1YA';
    const SK = 'NVDSvPLB6HeLROD9piOwBjeUl45Reeb5zrhPKiLY';

    let fileQueue = [];
    let currentFileIndex = 0;
    let uploadTasks = [];
    let isProcessing = false;

    const s3Client = new AWS.S3({ endpoint: W_END, accessKeyId: AK, secretAccessKey: SK, s3ForcePathStyle: true, signatureVersion: 'v4' });

    async function initMenu() {
        const r = await fetch(`${X_BASE}/uploader_get_franchises`);
        const data = await r.json();
        const sel = document.getElementById('franchiseSelect');
        data.forEach(f => { sel.innerHTML += `<option value="${f.id}">${f.name}</option>`; });
    }

    async function loadDependencies() {
        const fid = document.getElementById('franchiseSelect').value;
        if(!fid) return;
        document.getElementById('teacherSection').style.display = 'block';
        document.getElementById('filePickerSection').style.display = 'block';
        const [t, s] = await Promise.all([
            fetch(`${X_BASE}/uploader_get_teachers?franchise_id=${fid}`).then(res => res.json()),
            fetch(`${X_BASE}/uploader_get_students?franchise_id=${fid}`).then(res => res.json())
        ]);
        const ts = document.getElementById('teacherSelect');
        ts.innerHTML = '<option value="">-- Select Teacher --</option>';
        t.forEach(item => ts.innerHTML += `<option value="${item.id}">${item.first_name}</option>`);
        const ss = document.getElementById('studentSelect');
        ss.innerHTML = '<option value="">-- Select Student --</option>';
        s.forEach(item => ss.innerHTML += `<option value="${item.id}">${item.name}</option>`);
    }

    function startQueue() {
        const files = document.getElementById('fileInput').files;
        if (!document.getElementById('teacherSelect').value) return alert("Select teacher first.");
        if (files.length === 0) return;
        fileQueue = Array.from(files);
        currentFileIndex = 0;
        document.getElementById('setupView').style.display = 'none';
        document.getElementById('batchCard').style.display = 'block';
        showCurrentFile();
    }

    function showCurrentFile() {
        const file = fileQueue[currentFileIndex];
        const container = document.getElementById('previewContainer');
        const badge = `PHOTO ${currentFileIndex + 1} OF ${fileQueue.length}`;
        
        // Step 1: Memory Flush - Completely wipe the old preview
        container.innerHTML = ""; 
        document.getElementById('studentSelect').value = "";

        // Step 2: Load New Preview
        const reader = new FileReader();
        reader.onload = (e) => {
            container.innerHTML = `<div class="batch-badge">${badge}</div><img src="${e.target.result}" id="activeImg">`;
            // Clean up the reader reference to save memory
            reader.onload = null;
        };
        reader.readAsDataURL(file);
    }

    function queueAndNext() {
        const sid = document.getElementById('studentSelect').value;
        const sName = document.getElementById('studentSelect').options[document.getElementById('studentSelect').selectedIndex].text;
        if (!sid) return alert("Select a student.");

        // Capture data for background task
        const task = {
            file: fileQueue[currentFileIndex],
            sid: sid,
            sName: sName,
            tid: document.getElementById('teacherSelect').value,
            fid: document.getElementById('franchiseSelect').value,
            localSrc: document.getElementById('activeImg') ? document.getElementById('activeImg').src : null
        };

        uploadTasks.push(task);
        document.getElementById('task-counter').style.display = 'block';
        document.getElementById('pending-count').innerText = uploadTasks.length;

        // Start background worker if idle
        if (!isProcessing) runWorker();

        // Step 3: Advance UI immediately
        currentFileIndex++;
        if (currentFileIndex < fileQueue.length) {
            showCurrentFile();
        } else {
            document.getElementById('batchCard').style.display = 'none';
            document.getElementById('finalSummary').style.display = 'block';
            renderSummary();
        }
    }

    async function runWorker() {
        if (uploadTasks.length === 0) {
            isProcessing = false;
            document.getElementById('task-counter').style.background = "#059669";
            document.getElementById('task-counter').innerText = "All Secure! âœ“";
            return;
        }

        isProcessing = true;
        const current = uploadTasks[0];
        const domId = "sum-" + current.file.name.replace(/[^a-z0-9]/gi, '');

        try {
            let blob = current.file;
            if (current.file.type.startsWith('image/')) {
                blob = await imageCompression(current.file, { maxSizeMB: 0.6, maxWidthOrHeight: 1400 });
            }

            const key = `vault/franchise_${current.fid}/student_${current.sid}/${Date.now()}_${blob.name}`;
            const upload = await s3Client.upload({ Bucket: BKT, Key: key, Body: blob, ContentType: blob.type, ACL: 'public-read' }).promise();

            await fetch(`${X_BASE}/uploader_register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    franchise_id: parseInt(current.fid),
                    student_id: parseInt(current.sid),
                    teacher_id: parseInt(current.tid),
                    file_url: upload.Location,
                    file_type: current.file.type.includes('image') ? 'image' : 'video'
                })
            });

            const el = document.getElementById(domId);
            if(el) {
                el.style.borderColor = "#059669";
                if(current.localSrc) el.innerHTML = `<img src="${current.localSrc}"><div class="summary-name">${current.sName}</div>`;
            }
        } catch (e) {
            const el = document.getElementById(domId);
            if(el) el.style.borderColor = "red";
        }

        uploadTasks.shift(); // Move to next task
        document.getElementById('pending-count').innerText = uploadTasks.length;
        runWorker(); 
    }

    function renderSummary() {
        const grid = document.getElementById('summaryGrid');
        grid.innerHTML = "";
        fileQueue.forEach(f => {
            const div = document.createElement('div');
            div.className = 'summary-item';
            div.id = "sum-" + f.name.replace(/[^a-z0-9]/gi, '');
            div.innerHTML = `<div style="padding:10px; font-size:10px;">Securing...</div>`;
            grid.appendChild(div);
        });
    }

    initMenu();
</script>
