<div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div style="margin-bottom: 20px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px;">1. Select School Location</label>
        <select id="franchiseSelect" onchange="loadDependencies()" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <option value="">-- Choose Location --</option>
        </select>
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px;">2. Teacher Name</label>
        <select id="teacherSelect" disabled style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <option value="">-- Select Teacher --</option>
        </select>
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px;">3. Student Name</label>
        <select id="studentSelect" disabled style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <option value="">-- Select Student --</option>
        </select>
    </div>

    <div style="margin-bottom: 20px;">
        <label style="display:block; font-weight:bold; margin-bottom:5px;">4. Select File</label>
        <input type="file" id="fileInput" accept="image/*,video/*" style="width:100%;">
    </div>

    <button id="uploadBtn" onclick="handleUpload()" style="width:100%; background:#1e3a8a; color:white; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer;">
        Upload to Vault
    </button>
    <div id="status" style="margin-top:15px; font-size:14px; text-align:center; color:#666;">Ready.</div>

    <script>
        const X_BASE = 'https://x8ki-letl-twmt.n7.xano.io/api:I12II1nL';
        const W_END = 's3.ap-southeast-1.wasabisys.com';
        const BKT = 'the-little-nest-media';
        const AK = 'P7GI5LQMI4OX2SPAV1YA';
        const SK = 'NVDSvPLB6HeLROD9piOwBjeUl45Reeb5zrhPKiLY';

        const s3Client = new AWS.S3({ endpoint: W_END, accessKeyId: AK, secretAccessKey: SK, s3ForcePathStyle: true, signatureVersion: 'v4' });

        async function initMenu() {
            try {
                const r = await fetch(`${X_BASE}/uploader_get_franchises`);
                const data = await r.json();
                const sel = document.getElementById('franchiseSelect');
                data.forEach(f => { sel.innerHTML += `<option value="${f.id}">${f.name}</option>`; });
            } catch (e) { document.getElementById('status').innerText = "Xano Connection Error."; }
        }

        async function loadDependencies() {
            const fid = document.getElementById('franchiseSelect').value;
            if(!fid) return;
            document.getElementById('status').innerText = "Syncing lists...";
            try {
                const [t, s] = await Promise.all([
                    fetch(`${X_BASE}/uploader_get_teachers?franchise_id=${fid}`).then(res => res.json()),
                    fetch(`${X_BASE}/uploader_get_students?franchise_id=${fid}`).then(res => res.json())
                ]);
                const ts = document.getElementById('teacherSelect');
                ts.innerHTML = '<option value="">-- Select Teacher --</option>';
                t.forEach(item => ts.innerHTML += `<option value="${item.id}">${item.first_name}</option>`);
                ts.disabled = false;
                const ss = document.getElementById('studentSelect');
                ss.innerHTML = '<option value="">-- Select Student --</option>';
                s.forEach(item => ss.innerHTML += `<option value="${item.id}">${item.name}</option>`);
                ss.disabled = false;
                document.getElementById('status').innerText = "Ready to upload.";
            } catch (e) { document.getElementById('status').innerText = "Error syncing lists."; }
        }

        async function handleUpload() {
            let file = document.getElementById('fileInput').files[0];
            const fid = document.getElementById('franchiseSelect').value;
            const sid = document.getElementById('studentSelect').value;
            const tid = document.getElementById('teacherSelect').value;

            if (!file || !fid || !sid || !tid) return alert("Select all fields.");

            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');
            btn.disabled = true;

            // --- IMAGE COMPRESSION ---
            if (file.type.startsWith('image/')) {
                status.innerText = "Optimizing image for vault...";
                const options = {
                    maxSizeMB: 1,
                    maxWidthOrHeight: 1920,
                    useWebWorker: true
                };
                try {
                    file = await imageCompression(file, options);
                } catch (error) {
                    console.error("Compression failed:", error);
                }
            }

            status.innerText = "Uploading to Wasabi...";
            const key = `vault/franchise_${fid}/student_${sid}/${Date.now()}_${file.name}`;

            try {
                const up = await s3Client.upload({ Bucket: BKT, Key: key, Body: file, ContentType: file.type, ACL: 'public-read' }).promise();
                status.innerText = "Registering file in database...";
                await fetch(`${X_BASE}/uploader_register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        franchise_id: parseInt(fid), student_id: parseInt(sid), teacher_id: parseInt(tid),
                        file_url: up.Location, file_type: file.type.includes('image') ? 'image' : 'video'
                    })
                });
                status.innerText = "Success! Upload secured.";
                document.getElementById('fileInput').value = "";
            } catch (e) { status.innerText = "Error: " + e.message; }
            finally { btn.disabled = false; }
        }
        initMenu();
    </script>
</div>
