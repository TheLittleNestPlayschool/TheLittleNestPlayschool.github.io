<div id="step-pickup" class="step-container step-locked">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="font-size: 0.9rem;" class="nest-header"><span class="badge-step">4</span> Authorized Pickup</h2>
        <span id="pickup-success" class="success-check" style="display:none;">âœ“ Complete</span>
    </div>
    <div id="added-pickups-list" style="margin-bottom: 5px;"></div>
    <form id="pickupForm" style="margin-top: 5px;">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
            <div><label>Contact Name</label><input type="text" id="pk_name" required></div>
            <div><label>Relationship</label><input type="text" id="pk_relationship" required></div>
            <div><label>Phone</label><input type="text" id="pk_phone" required></div>
            <div><label>Type</label><select id="pk_type"><option value="Pickup">Pickup</option><option value="Emergency">Emergency</option><option value="Photo Release">Photo Release</option><option value="Other">Other</option></select></div>
        </div>
        <div style="margin-top: 8px; display: flex; justify-content: space-between;">
            <button type="button" onclick="finalizePickups()" class="btn-teal" style="background:#64748b;">Next Step</button>
            <button type="submit" class="btn-teal">+ Add Contact</button>
        </div>
    </form>
</div>

<script>
(function() {
    const PICKUP_API = "https://x8ki-letl-twmt.n7.xano.io/api:iEHfqd-N/student_authorized_pickup";

    document.getElementById('pickupForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = { 
            student_id: curStudentId, 
            name: document.getElementById('pk_name').value, 
            relationship: document.getElementById('pk_relationship').value, 
            phone: document.getElementById('pk_phone').value, 
            type: document.getElementById('pk_type').value, 
            is_active: true 
        };
        const res = await fetch(PICKUP_API, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if(data.id) {
            const list = document.getElementById('added-pickups-list');
            list.innerHTML += `<div style="font-size:0.75rem; padding:4px; border-bottom:1px solid #eee;"><strong>${data.name}</strong> (${data.type}) - ${data.phone}</div>`;
            document.getElementById('pickupForm').reset();
        }
    };

    window.finalizePickups = () => {
        document.getElementById('pickup-success').style.display = 'inline';
        document.getElementById('step-pickup').classList.replace('step-active', 'step-saved');
        alert("Contacts Finalized. Ready for Step 5.");
    };
})();
</script>
