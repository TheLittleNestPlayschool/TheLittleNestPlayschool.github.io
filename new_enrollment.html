<style>
    .nest-header { font-family: 'Georgia', serif; color: #1a365d; }
    .step-container { background: white; border: 1px solid #e2e8f0; border-radius: 4px; padding: 10px; margin-bottom: 6px; }
    .step-locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
    .step-active { border-left: 3px solid #00d1b2; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .step-saved { border-left: 3px solid #00d1b2; background: #f8fafc; padding: 4px 10px; }
    .step-saved form { display: none; }
    
    label { display: block; font-size: 0.55rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 1px; margin-top: 2px; }
    input, select, textarea { width: 100%; border: 1px solid #cbd5e1; padding: 4px 6px; border-radius: 2px; font-size: 0.7rem; background: #fff; }
    .btn-teal { background-color: #00d1b2; color: white; padding: 5px 12px; border-radius: 2px; font-weight: 900; border: none; cursor: pointer; font-size: 0.65rem; text-transform: uppercase; }
    .badge-step { background: #1a365d; color: white; width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.6rem; margin-right: 6px; }
    .success-check { color: #00d1b2; font-weight: bold; font-size: 0.65rem; font-style: italic; }
</style>

<div style="max-width: 900px; margin: 0 auto;">
    <div style="text-align: right; font-size: 0.55rem; font-weight: 800; color: #94a3b8; margin-bottom: 5px;">STEP 3 OF 5</div>

    <div id="step-parent" class="step-container step-saved">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 0.85rem;" class="nest-header"><span class="badge-step">1</span> Parent Information</h2>
            <span class="success-check">✓ Saved</span>
        </div>
    </div>

    <div id="step-student" class="step-container step-saved">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 0.85rem;" class="nest-header"><span class="badge-step">2</span> Student Details</h2>
            <span class="success-check">✓ Saved</span>
        </div>
    </div>

    <div id="step-assessment" class="step-container step-active">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 0.85rem;" class="nest-header"><span class="badge-step">3</span> Student Assessment</h2>
            <span id="assessment-success" class="success-check" style="display:none;">✓ Saved</span>
        </div>
        <form id="assessmentForm" style="margin-top: 5px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                <div><label>Teacher</label><select id="a_teacher_id" required><option value="">Select...</option></select></div>
                <div><label>Date</label><input type="date" id="a_assessment_date" required></div>
                <div><label>Assessment Type</label><input type="text" id="a_assessment_type" placeholder="Initial Assessment" required></div>
            </div>
            
            <div id="dynamic-questions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px 15px; margin-top: 8px; border-top: 1px solid #eee; padding-top: 5px;">
                </div>

            <div style="margin-top: 5px;"><label>Comments</label><textarea id="a_comments" rows="2"></textarea></div>
            
            <div style="margin-top: 8px; display: flex; justify-content: flex-end;">
                <button type="submit" class="btn-teal">Save Assessment & Continue</button>
            </div>
        </form>
    </div>

    <div id="step-pickup" class="step-container step-locked">
        <h2 style="font-size: 0.85rem; color: #94a3b8;"><span class="badge-step">4</span> Authorized Pickup</h2>
    </div>
</div>

<script>
(function() {
    const TEACHER_API = "https://x8ki-letl-twmt.n7.xano.io/api:xLIeVP2e/teacher";
    const QUESTIONS_API = "https://x8ki-letl-twmt.n7.xano.io/api:ptE37CdX/student_assessment_questions";
    const ASSESSMENT_API = "https://x8ki-letl-twmt.n7.xano.io/api:iEHfqd-N/student_assessment";

    let questionMap = [];
    let curStudentId = null; // Inherited from previous step
    let curFranchiseId = null; // Inherited from previous step

    async function initAssessment() {
        try {
            const [tRes, qRes] = await Promise.all([fetch(TEACHER_API), fetch(QUESTIONS_API)]);
            const [teachers, questions] = await Promise.all([tRes.json(), qRes.json()]);
            
            const tSelect = document.getElementById('a_teacher_id');
            teachers.forEach(t => { 
                tSelect.innerHTML += `<option value="${t.id}">${t.first_name} ${t.last_name}</option>`; 
            });

            const qContainer = document.getElementById('dynamic-questions');
            questionMap = questions.slice(0, 10);
            questionMap.forEach((q, idx) => {
                const i = idx + 1;
                qContainer.innerHTML += `<div><label>${q.question_text || 'Q'+i}</label><input type="text" id="a_recorded_answer_${i}"></div>`;
            });
        } catch (e) { console.error(e); }
    }

    document.getElementById('assessmentForm').onsubmit = async (e) => {
        e.preventDefault();
        let payload = { 
            student_id: curStudentId, 
            teacher_id: parseInt(document.getElementById('a_teacher_id').value), 
            assessment_date: document.getElementById('a_assessment_date').value, 
            assessment_type: document.getElementById('a_assessment_type').value, 
            comments: document.getElementById('a_comments').value, 
            franchise_id: curFranchiseId 
        };
        
        questionMap.forEach((q, idx) => {
            const i = idx + 1;
            payload[`question_${i}_id`] = q.id;
            payload[`recorded_answer_${i}`] = document.getElementById(`a_recorded_answer_${i}`).value;
        });

        try {
            const res = await fetch(ASSESSMENT_API, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload) 
            });
            const data = await res.json();
            if (data.id) {
                document.getElementById('assessment-success').style.display = 'inline';
                document.getElementById('step-assessment').classList.replace('step-active', 'step-saved');
                document.getElementById('step-pickup').classList.remove('step-locked');
                document.getElementById('step-pickup').classList.add('step-active');
            }
        } catch (err) { alert("Error saving assessment."); }
    };

    initAssessment();
})();
</script>
