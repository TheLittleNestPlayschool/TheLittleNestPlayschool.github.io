<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Master Admin Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--max-width:1400px; --primary: #74e8e8; --secondary: #498787; --bg: #e8ffff; --input-bg: #ffeffb;}
body{ font-family:Arial,Helvetica,sans-serif; margin:16px auto; padding:18px; max-width:var(--max-width); font-size:15px; background-color:var(--bg); }
.tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 10px; }
.tab-btn { padding: 10px 20px; background: #fff; border: 1px solid var(--primary); cursor: pointer; border-radius: 4px; font-weight: bold; }
.tab-btn.active { background: var(--primary); color: #000; }
.tab-content { display: none; }
.tab-content.active { display: block; }
form .record-line{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:10px }
.record-field{ display:flex; flex-direction:column }
input,textarea,select{ padding:8px; font-size:14px; box-sizing:border-box; background-color:var(--input-bg); border:1px solid #ccc; border-radius:4px; width:100%; }
textarea{min-height:56px; resize:vertical}
button{ padding:8px 12px; font-size:14px; background-color:var(--primary); border:none; border-radius:4px; cursor:pointer; transition:0.2s; }
button:hover{ background-color:var(--secondary); color:#fff; }
button:disabled { background-color: #ccc; cursor: not-allowed; color: #666; }
.gallery-section { background: #fff5fd; padding: 12px; margin-top: 10px; border-radius: 6px; border: 1px dashed var(--primary); }
.gallery-grid { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; min-height: 50px; }
.gallery-item { width: 90px; position: relative; border: 1px solid #ccc; border-radius: 4px; background: white; padding: 2px; }
.gallery-item img { width: 100%; height: 60px; object-fit: cover; border-radius: 2px; }
.del-img { position: absolute; top: -8px; right: -8px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; font-weight: bold; }
#tableWrapper{ max-height:700px; overflow-y:auto; border:1px solid #ddd; padding:8px; border-radius:6px; background:#fff; }
table{ width:100%; border-collapse:collapse; table-layout:fixed; }
th,td{ border:1px solid #e6e6e6; padding:10px; vertical-align:top; font-size:13px; }
.record-line-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:6px; }
.record-field label{ font-size:11px; font-weight: bold; color:#555; margin-bottom:4px }
.actions button{ display:block; width:100%; margin:6px auto; }
.pagination{ display:flex; gap:6px; justify-content:center; margin-top:12px; }
.page-btn{ padding:6px 10px; border:1px solid #ccc; background:var(--primary); cursor:pointer; border-radius:4px }
.page-btn.active{background:var(--secondary); color:#fff;}
.source-tag { display: inline-block; background: #eee; padding: 2px 6px; border-radius: 4px; margin: 2px; font-size: 11px; border: 1px solid #ccc; }
@media (max-width:1200px){ .record-line-grid, form .record-line{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>

<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab(event, 'posts')">Blog Posts</button>
    <button class="tab-btn" onclick="switchTab(event, 'categories')">Categories</button>
    <button class="tab-btn" onclick="switchTab(event, 'analytics')">Analytics</button>
</div>

<div id="posts" class="tab-content active">
    <h2>Create New Blog Post</h2>
    <form id="add-post-form">
      <div class="record-line">
        <div class="record-field" style="grid-column: span 2;">
            <label>Title</label>
            <input type="text" id="post_title" required oninput="autoSlug('post_title', 'post_slug_hidden')">
            <input type="hidden" id="post_slug_hidden">
        </div>
        <div class="record-field">
            <label>Category</label>
            <select id="post_category_select" required></select>
        </div>
        <div class="record-field">
            <label>Author</label>
            <input type="text" id="post_author_display" disabled>
        </div>
      </div>
      <div class="record-line">
        <div class="record-field" style="grid-column: span 2;">
            <label>Featured Image (File Upload)</label>
            <input type="file" id="post_f_img_file" accept="image/*">
        </div>
        <div class="record-field">
          <label>Status</label>
          <select id="post_status">
            <option value="true">Published</option>
            <option value="false" selected>Draft</option>
          </select>
        </div>
        <div class="record-field"><label>Publish Date</label><input type="date" id="post_date"></div>
      </div>
      <div class="record-field" style="margin-bottom:10px;">
        <label>Post Content</label>
        <textarea id="post_content" style="min-height:80px"></textarea>
      </div>
      <button type="submit" id="add-post-btn" style="width:160px;">Add Post</button>
    </form>

    <div style="margin: 20px 0;"><input id="searchInput" placeholder="Search titles..." oninput="handleSearch()" /></div>

    <div id="tableWrapper">
        <table>
            <thead><tr><th style="width:50px">ID</th><th>Post Details & Gallery</th><th style="width:120px">Actions</th></tr></thead>
            <tbody id="posts-table-body"></tbody>
        </table>
    </div>
    <div class="pagination" id="pagination"></div>
</div>

<div id="categories" class="tab-content">
    <h2>Manage Categories</h2>
    <form id="add-category-form" autocomplete="off" style="background:#fff; padding:15px; border-radius:6px; margin-bottom:20px; border:1px solid #ccc;">
        <div class="record-line">
            <div class="record-field" style="grid-column: span 2;">
                <label>Category Name</label>
                <input type="text" id="cat_name" required oninput="autoSlug('cat_name', 'cat_slug_hidden')">
                <input type="hidden" id="cat_slug_hidden">
            </div>
            <div class="record-field"><label>Status</label><select id="cat_is_active"><option value="true">Active</option><option value="false">Inactive</option></select></div>
            <div class="record-field"><label>&nbsp;</label><button type="submit">Add Category</button></div>
        </div>
        <div class="record-field"><label>Description</label><textarea id="cat_desc" style="min-height:40px"></textarea></div>
    </form>
    <div id="tableWrapper">
        <table>
            <thead><tr><th style="width:50px">ID</th><th>Category Details</th><th style="width:120px">Actions</th></tr></thead>
            <tbody id="category-table-body"></tbody>
        </table>
    </div>
</div>

<div id="analytics" class="tab-content">
    <h2>Post Performance Analytics</h2>
    <div id="tableWrapper">
        <table>
            <thead>
                <tr>
                    <th style="width:120px">Views (Uniq/Tot)</th>
                    <th>Blog Post Title</th>
                    <th style="width:150px">Created At</th>
                    <th>Source Breakdown</th>
                </tr>
            </thead>
            <tbody id="analytics-table-body"></tbody>
        </table>
    </div>
</div>

<script>
const apiPost = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_post";
const apiImg = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_image";
const apiCat = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_category";
const apiAnalytics = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_analytics";

const rawUserData = localStorage.getItem('currentUser'); 
const currentUser = rawUserData ? JSON.parse(rawUserData) : { name: "Dave Test 2", id: 1 };

let allPosts = [], filteredPosts = [], categories = [], currentPage = 1, PAGE_SIZE = 10;

function setAuthorUI() { document.getElementById('post_author_display').value = currentUser.name; }
function autoSlug(src, target) { 
    const val = document.getElementById(src).value.toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '');
    document.getElementById(target).value = val;
}
function switchTab(e, tabId) {
    document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(e) e.currentTarget.classList.add('active');
    if(tabId === 'categories') fetchCategories();
    if(tabId === 'analytics') fetchAnalyticsSummary();
    if(tabId === 'posts') initPosts();
}

async function fetchCategories() {
    const res = await fetch(apiCat);
    categories = await res.json();
    renderCategoryTable();
    const catSel = document.getElementById('post_category_select');
    if(catSel) catSel.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function renderCategoryTable() {
    const catBody = document.getElementById('category-table-body');
    if(!catBody) return;
    catBody.innerHTML = categories.map(c => `
        <tr>
            <td>${c.id}</td>
            <td>
                <div class="record-line-grid">
                    <div class="record-field"><label>Name</label><input data-cat="name" value="${c.name}" disabled></div>
                    <div class="record-field"><label>Slug</label><input data-cat="slug" value="${c.slug}" disabled></div>
                    <div class="record-field"><label>Status</label><select data-cat="is_active" disabled><option value="true" ${c.is_active?'selected':''}>Active</option><option value="false" ${!c.is_active?'selected':''}>Inactive</option></select></div>
                </div>
                <textarea data-cat="description" disabled>${c.description||''}</textarea>
            </td>
            <td class="actions"><button onclick="editCat(this,${c.id})">Edit</button><button onclick="deleteCat(${c.id})" style="background:#ffb3b3">Delete</button></td>
        </tr>`).join('');
}

async function editCat(btn, id) {
    const tr = btn.closest('tr');
    const inputs = tr.querySelectorAll('input, select, textarea');
    if(btn.textContent === 'Edit') { inputs.forEach(i => i.disabled = false); btn.textContent = 'Save'; return; }
    btn.disabled = true; btn.textContent = "Saving...";
    const payload = {}; inputs.forEach(i => { if(i.dataset.cat) payload[i.dataset.cat] = i.dataset.cat==='is_active'?(i.value==='true'):i.value; });
    await fetch(`${apiCat}/${id}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    btn.textContent = 'Edit'; btn.disabled = false; fetchCategories();
}

async function deleteCat(id) { if(confirm('Delete Category?')) { await fetch(`${apiCat}/${id}`, {method:'DELETE'}); fetchCategories(); } }

document.getElementById('add-category-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button'); btn.disabled = true; btn.textContent = "...";
    const p = { name:cat_name.value, slug:cat_slug_hidden.value, description:cat_desc.value, is_active:cat_is_active.value==='true', created_at:Date.now() };
    await fetch(apiCat, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(p)});
    e.target.reset(); btn.disabled = false; btn.textContent = "Add Category"; fetchCategories();
};

async function initPosts() {
    await fetchCategories();
    const res = await fetch(apiPost);
    allPosts = await res.json();
    filteredPosts = [...allPosts];
    renderPosts();
    setAuthorUI();
}

document.getElementById('add-post-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('add-post-btn');
    const fileInput = document.getElementById('post_f_img_file');
    btn.disabled = true; btn.textContent = "Processing...";

    try {
        const postPayload = {
            title: post_title.value,
            slug: post_slug_hidden.value,
            content: post_content.value,
            blog_category_id: parseInt(post_category_select.value),
            author_user_id: currentUser.id,
            is_published: post_status.value === 'true',
            created_at: Date.now()
        };

        const postRes = await fetch(apiPost, { 
            method:'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(postPayload) 
        });
        const newPost = await postRes.json();

        if(fileInput.files[0] && newPost.id) {
            const fdImg = new FormData();
            // Matching the 'blog_image' input object from your Xano screenshot
            fdImg.append('blog_image[image_file]', fileInput.files[0]);
            fdImg.append('blog_image[blog_post_id]', newPost.id);
            fdImg.append('blog_image[order_number]', 0); 
            
            const imgRes = await fetch(apiImg, { method:'POST', body:fdImg });
            const imgData = await imgRes.json();

            if(imgData.id) {
                await fetch(`${apiPost}/${newPost.id}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ featured_blog_image_id: imgData.id })
                });
            }
        }
    } catch (err) { console.error("Post Creation Failed:", err); }

    btn.disabled = false; btn.textContent = "Add Post";
    e.target.reset(); initPosts();
};

async function uploadGallery(postId, btn) {
    const fileInput = document.getElementById(`img-file-${postId}`);
    if (!fileInput.files.length) return;
    btn.disabled = true; btn.textContent = "Uploading...";
    for(let f of fileInput.files) {
        const fd = new FormData(); 
        fd.append('blog_image[blog_post_id]', postId); 
        fd.append('blog_image[image_file]', f);
        fd.append('blog_image[order_number]', 1); 
        await fetch(apiImg, { method:'POST', body:fd });
    }
    fileInput.value=''; 
    btn.disabled = false; btn.textContent = "Upload Photos";
    loadGallery(postId);
}

async function deletePost(id) { if(confirm('Delete Post?')) { await fetch(`${apiPost}/${id}`, {method:'DELETE'}); initPosts(); } }
async function deleteImg(imgId, postId) { await fetch(`${apiImg}/${imgId}`, {method:'DELETE'}); loadGallery(postId); }

function renderPosts() {
    const tbody = document.getElementById('posts-table-body');
    tbody.innerHTML = '';
    let start = (currentPage-1) * PAGE_SIZE, end = Math.min(start + PAGE_SIZE, filteredPosts.length);
    for(let i=start; i<end; i++) {
        const p = filteredPosts[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.id}</td>
            <td>
                <div class="record-line-grid">
                    <div class="record-field"><label>Title</label><input data-post="title" value="${p.title}" disabled></div>
                    <div class="record-field"><label>Category</label><select data-post="blog_category_id" disabled>${categories.map(c=>`<option value="${c.id}" ${c.id===p.blog_category_id?'selected':''}>${c.name}</option>`).join('')}</select></div>
                    <div class="record-field"><label>Status</label><select data-post="is_published" disabled><option value="true" ${p.is_published?'selected':''}>Published</option><option value="false" ${!p.is_published?'selected':''}>Draft</option></select></div>
                    <div class="record-field"><label>Author ID</label><input value="${p.author_user_id || ''}" disabled></div>
                </div>
                <textarea data-post="content" disabled>${p.content||''}</textarea>
                <div class="gallery-section">
                    <div class="gallery-grid" id="gal-${p.id}">No images yet.</div>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <input type="file" id="img-file-${p.id}" multiple accept="image/*">
                        <button onclick="uploadGallery(${p.id}, this)">Upload Photos</button>
                    </div>
                </div>
            </td>
            <td class="actions"><button onclick="editPost(this,${p.id})">Edit Post</button><button onclick="deletePost(${p.id})" style="background:#ffb3b3">Delete</button></td>`;
        tbody.appendChild(tr); loadGallery(p.id);
    }
    renderPagination();
}

async function editPost(btn, id) {
    const tr = btn.closest('tr'); const inputs = tr.querySelectorAll('input, select, textarea');
    if(btn.textContent === 'Edit Post') { inputs.forEach(i=>i.disabled=false); btn.textContent='Save'; return; }
    btn.disabled = true; btn.textContent = "Saving...";
    const pld = {}; 
    inputs.forEach(i=>{ if(i.dataset.post) pld[i.dataset.post] = i.dataset.post==='is_published'?(i.value==='true'):(i.dataset.post==='blog_category_id'?parseInt(i.value):i.value); });
    await fetch(`${apiPost}/${id}`, {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify(pld)});
    btn.textContent='Edit Post'; btn.disabled = false; initPosts();
}

async function loadGallery(postId) {
    try {
        const res = await fetch(`${apiImg}?blog_post_id=${postId}`);
        const imgs = await res.json();
        const cont = document.getElementById(`gal-${postId}`);
        if(!cont) return;

        // Ensure we have an array and filter by this specific post ID
        const postImgs = (Array.isArray(imgs) ? imgs : []).filter(img => img.blog_post_id === postId);

        if(postImgs.length === 0) {
            cont.innerHTML = "<small>No images uploaded for this post.</small>";
            return;
        }

        cont.innerHTML = postImgs.map(img => `
            <div class="gallery-item">
                <img src="${img.image_file?.url || ''}">
                <button class="del-img" onclick="deleteImg(${img.id},${postId})">Ã—</button>
            </div>`).join('');
    } catch (e) {
        document.getElementById(`gal-${postId}`).innerHTML = "<small>Error loading gallery.</small>";
    }
}

async function fetchAnalyticsSummary() {
    const [pRes, lRes] = await Promise.all([fetch(apiPost), fetch(apiAnalytics)]);
    const posts = await pRes.json(), logs = await lRes.json();
    const anaBody = document.getElementById('analytics-table-body');
    if(!anaBody) return;
    anaBody.innerHTML = posts.map(post => {
        const postLogs = logs.filter(l => l.blog_post_id === post.id);
        const uniqueIPs = new Set(postLogs.map(l => l.ip_address)).size;
        const sources = {}; postLogs.forEach(l => { const s = l.referrer || "Direct"; sources[s] = (sources[s] || 0) + 1; });
        const sourceTags = Object.entries(sources).sort((a,b)=>b[1]-a[1]).map(([n, c]) => `<span class="source-tag"><b>${n}</b>: ${c}</span>`).join('');
        return `<tr><td style="text-align:center"><b>${uniqueIPs}</b> / ${postLogs.length}</td><td>${post.title}</td><td>${new Date(post.created_at).toLocaleDateString()}</td><td>${sourceTags || '<small>None</small>'}</td></tr>`;
    }).join('');
}

function handleSearch() {
    const v = document.getElementById('searchInput').value.toLowerCase();
    filteredPosts = allPosts.filter(p => p.title.toLowerCase().includes(v));
    currentPage = 1; renderPosts();
}

function renderPagination() {
    const p = document.getElementById('pagination'); if(!p) return; p.innerHTML = '';
    const total = Math.ceil(filteredPosts.length / PAGE_SIZE);
    for(let i=1; i<=total; i++) {
        const b = document.createElement('button'); b.className = 'page-btn'+(i===currentPage?' active':'');
        b.textContent = i; b.onclick = () => { currentPage = i; renderPosts(); }; p.appendChild(b);
    }
}

initPosts();
</script>
</body>
</html>
