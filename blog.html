<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Blog Dashboard: Auto-Slug Integrated</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
:root{--max-width:1400px; --primary: #74e8e8; --secondary: #498787; --bg: #e8ffff; --input-bg: #ffeffb;}

body{
  font-family:Arial,Helvetica,sans-serif;
  margin:16px auto;
  padding:18px;
  max-width:var(--max-width);
  font-size:15px;
  background-color:var(--bg);
}

/* ---------- Tab Switcher ---------- */
.tab-nav {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 10px;
}
.tab-btn {
    padding: 10px 20px;
    background: #fff;
    border: 1px solid var(--primary);
    cursor: pointer;
    border-radius: 4px;
    font-weight: bold;
}
.tab-btn.active {
    background: var(--primary);
    color: #000;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ---------- Forms & Layout ---------- */
form .record-line{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-bottom:10px
}
.record-field{ display:flex; flex-direction:column }

input,textarea,select{
  padding:8px;
  font-size:14px;
  box-sizing:border-box;
  background-color:var(--input-bg);
  border:1px solid #ccc;
  border-radius:4px;
  width:100%;
}
textarea{min-height:56px; resize:vertical}

button{
  padding:8px 12px;
  font-size:14px;
  background-color:var(--primary);
  border:none;
  border-radius:4px;
  cursor:pointer;
  transition:0.2s;
}
button:hover{ background-color:var(--secondary); color:#fff; }

/* ---------- Gallery ---------- */
.gallery-section {
    background: #fff5fd;
    padding: 12px;
    margin-top: 10px;
    border-radius: 6px;
    border: 1px dashed var(--primary);
}
.gallery-grid { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; min-height: 50px; }
.gallery-item {
    width: 90px;
    position: relative;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: white;
    padding: 2px;
}
.gallery-item img { width: 100%; height: 60px; object-fit: cover; border-radius: 2px; }
.del-img {
    position: absolute; top: -8px; right: -8px; background: #ff4d4d;
    color: white; border: none; border-radius: 50%; width: 20px; height: 20px;
    cursor: pointer; font-size: 12px; font-weight: bold;
}

/* ---------- Tables ---------- */
#tableWrapper{
  max-height:700px;
  overflow-y:auto;
  border:1px solid #ddd;
  padding:8px;
  border-radius:6px;
  background:#fff;
}
table{ width:100%; border-collapse:collapse; table-layout:fixed; }
th,td{ border:1px solid #e6e6e6; padding:10px; vertical-align:top; font-size:13px; }
.record-line-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:6px; }
.record-field label{ font-size:11px; font-weight: bold; color:#555; margin-bottom:4px }
.actions button{ display:block; width:100%; margin:6px auto; }

.pagination{ display:flex; gap:6px; justify-content:center; margin-top:12px; }
.page-btn{ padding:6px 10px; border:1px solid #ccc; background:var(--primary); cursor:pointer; border-radius:4px }
.page-btn.active{background:var(--secondary); color:#fff;}

@media (max-width:1200px){
  .record-line-grid, form .record-line{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('posts')">Blog Posts</button>
    <button class="tab-btn" onclick="switchTab('categories')">Categories</button>
    <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
</div>

<div id="posts" class="tab-content active">
    <h2>Create New Blog Post</h2>
    <form id="add-post-form" autocomplete="off">
      <div class="record-line">
        <div class="record-field" style="grid-column: span 2;">
            <label>Title</label>
            <input type="text" id="post_title" placeholder="Enter post title..." required oninput="autoSlug('post_title', 'post_slug_hidden')">
            <input type="hidden" id="post_slug_hidden">
        </div>
        <div class="record-field">
            <label>Category</label>
            <select id="post_category_select" required></select>
        </div>
        <div class="record-field"><label>Author</label><input type="text" value="Active User" disabled></div>
      </div>
      <div class="record-line">
        <div class="record-field" style="grid-column: span 2;"><label>Featured Image URL</label><input type="text" id="post_f_img"></div>
        <div class="record-field">
          <label>Status</label>
          <select id="post_status">
            <option value="true">Published</option>
            <option value="false" selected>Draft</option>
          </select>
        </div>
        <div class="record-field"><label>Publish Date</label><input type="date" id="post_date"></div>
      </div>
      <div class="record-field" style="margin-bottom:10px;">
        <label>Post Content</label>
        <textarea id="post_content" style="min-height:80px"></textarea>
      </div>
      <button type="submit" style="width:160px;">Add Post</button>
    </form>

    <div style="margin: 20px 0;">
        <input id="searchInput" placeholder="Search titles..." oninput="handleSearch()" />
    </div>

    <div id="tableWrapper">
        <table id="posts-table">
            <thead>
                <tr><th style="width:50px">ID</th><th>Post Details & Gallery</th><th style="width:120px">Actions</th></tr>
            </thead>
            <tbody id="posts-table-body"></tbody>
        </table>
    </div>
    <div class="pagination" id="pagination"></div>
</div>

<div id="categories" class="tab-content">
    <h2>Manage Categories</h2>
    <form id="add-category-form" autocomplete="off" style="background:#fff; padding:15px; border-radius:6px; margin-bottom:20px; border:1px solid #ccc;">
        <div class="record-line">
            <div class="record-field" style="grid-column: span 2;">
                <label>Category Name</label>
                <input type="text" id="cat_name" required oninput="autoSlug('cat_name', 'cat_slug_hidden')">
                <input type="hidden" id="cat_slug_hidden">
            </div>
            <div class="record-field">
                <label>Status</label>
                <select id="cat_is_active">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="record-field"><label>&nbsp;</label><button type="submit">Add Category</button></div>
        </div>
        <div class="record-field"><label>Description</label><textarea id="cat_desc" style="min-height:40px"></textarea></div>
    </form>

    <div id="tableWrapper">
        <table>
            <thead><tr><th style="width:50px">ID</th><th>Category Details</th><th style="width:120px">Actions</th></tr></thead>
            <tbody id="category-table-body"></tbody>
        </table>
    </div>
</div>

<div id="analytics" class="tab-content">
    <h2>Traffic Audit Log</h2>
    <div id="tableWrapper">
        <table>
            <thead>
                <tr><th>Date</th><th>Post ID</th><th>IP Address</th><th>Referrer</th><th>Browser</th></tr>
            </thead>
            <tbody id="analytics-table-body"></tbody>
        </table>
    </div>
</div>

<script>
/* ---------- Helper: Slug Generator ---------- */
function generateSlug(text) {
    return text.toString().toLowerCase()
        .replace(/\s+/g, '-')           // Replace spaces with -
        .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
        .replace(/\-\-+/g, '-')         // Replace multiple - with single -
        .replace(/^-+/, '')             // Trim - from start
        .replace(/-+$/, '');            // Trim - from end
}

function autoSlug(sourceId, targetId) {
    const sourceVal = document.getElementById(sourceId).value;
    document.getElementById(targetId).value = generateSlug(sourceVal);
}

/* ---------- Config & State ---------- */
const CURRENT_USER_ID = 1; 
const apiPost = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_post";
const apiImg = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_image";
const apiCat = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_category";
const apiAnalytics = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_analytics";

let PAGE_SIZE = 10;
let allPosts = [], filteredPosts = [], categories = [], currentPage = 1;

/* ---------- Navigation ---------- */
function switchTab(tabId) {
    document.querySelectorAll('.tab-content, .tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    if(event) event.currentTarget.classList.add('active');
    
    if(tabId === 'categories') fetchCategories();
    if(tabId === 'analytics') fetchAnalytics();
    if(tabId === 'posts') initPosts();
}

/* ---------- Category CRUD ---------- */
async function fetchCategories() {
    const res = await fetch(apiCat);
    categories = await res.json();
    renderCategoryTable();
    renderCategoryDropdown();
}

function renderCategoryDropdown() {
    const sel = document.getElementById('post_category_select');
    sel.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function renderCategoryTable() {
    const tbody = document.getElementById('category-table-body');
    tbody.innerHTML = categories.map(c => `
        <tr>
            <td>${c.id}</td>
            <td>
                <div class="record-line-grid">
                    <div class="record-field"><label>Name</label><input data-cat="name" value="${c.name}" disabled></div>
                    <div class="record-field"><label>Slug (URL)</label><input data-cat="slug" value="${c.slug}" disabled></div>
                    <div class="record-field"><label>Status</label>
                        <select data-cat="is_active" disabled>
                            <option value="true" ${c.is_active?'selected':''}>Active</option>
                            <option value="false" ${!c.is_active?'selected':''}>Inactive</option>
                        </select>
                    </div>
                </div>
                <textarea data-cat="description" disabled>${c.description||''}</textarea>
            </td>
            <td class="actions">
                <button onclick="editCat(this,${c.id})">Edit</button>
                <button onclick="deleteCat(${c.id})" style="background:#ffb3b3">Delete</button>
            </td>
        </tr>
    `).join('');
}

document.getElementById('add-category-form').onsubmit = async (e) => {
    e.preventDefault();
    const payload = {
        name: cat_name.value, 
        slug: cat_slug_hidden.value, // Taken from hidden auto-generated field
        description: cat_desc.value, 
        is_active: cat_is_active.value === 'true', 
        created_at: Date.now()
    };
    await fetch(apiCat, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    e.target.reset();
    fetchCategories();
};

async function editCat(btn, id) {
    const tr = btn.closest('tr');
    const inputs = tr.querySelectorAll('input, select, textarea');
    if(btn.textContent === 'Edit') { inputs.forEach(i => i.disabled = false); btn.textContent = 'Save'; return; }
    
    const payload = {};
    inputs.forEach(i => {
        if(i.dataset.cat) payload[i.dataset.cat] = (i.dataset.cat === 'is_active') ? (i.value === 'true') : i.value;
        i.disabled = true;
    });
    await fetch(`${apiCat}/${id}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    btn.textContent = 'Edit';
    fetchCategories();
}

async function deleteCat(id) {
    if(confirm('Delete category?')) {
        await fetch(`${apiCat}/${id}`, { method: 'DELETE' });
        fetchCategories();
    }
}

/* ---------- Posts CRUD ---------- */
async function initPosts() {
    await fetchCategories();
    const res = await fetch(apiPost);
    allPosts = await res.json();
    filteredPosts = [...allPosts];
    renderPosts();
}

function renderPosts() {
    const tbody = document.getElementById('posts-table-body');
    tbody.innerHTML = '';
    let start = (currentPage-1) * PAGE_SIZE;
    let end = Math.min(start + PAGE_SIZE, filteredPosts.length);

    for(let i=start; i<end; i++) {
        const p = filteredPosts[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.id}</td>
            <td>
                <div class="record-line-grid">
                    <div class="record-field"><label>Title</label><input data-post="title" value="${p.title}" disabled></div>
                    <div class="record-field"><label>Slug (URL)</label><input data-post="slug" value="${p.slug}" disabled></div>
                    <div class="record-field"><label>Status</label>
                        <select data-post="is_published" disabled>
                            <option value="true" ${p.is_published?'selected':''}>Published</option>
                            <option value="false" ${!p.is_published?'selected':''}>Draft</option>
                        </select>
                    </div>
                    <div class="record-field"><label>Category</label>
                        <select data-post="blog_category_id" disabled>
                            ${categories.map(c => `<option value="${c.id}" ${c.id===p.blog_category_id?'selected':''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <textarea data-post="content" disabled>${p.content||''}</textarea>
                <div class="gallery-section">
                    <div class="gallery-grid" id="gal-${p.id}">Loading...</div>
                    <div style="margin-top:8px; display:flex; gap:5px;">
                        <input type="text" id="img-url-${p.id}" placeholder="Image URL">
                        <button onclick="addImg(${p.id})">Add</button>
                    </div>
                </div>
            </td>
            <td class="actions">
                <button onclick="editPost(this,${p.id})">Edit Post</button>
                <button onclick="deletePost(${p.id})" style="background:#ffb3b3">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
        loadGallery(p.id);
    }
    renderPagination();
}

async function editPost(btn, id) {
    const tr = btn.closest('tr');
    const inputs = tr.querySelectorAll('input, select, textarea');
    if(btn.textContent === 'Edit Post') { inputs.forEach(i => i.disabled = false); btn.textContent = 'Save'; return; }

    const payload = {};
    inputs.forEach(i => {
        if(i.dataset.post) {
            let val = i.value;
            if(i.dataset.post === 'is_published') val = (val === 'true');
            if(i.dataset.post === 'blog_category_id') val = parseInt(val);
            payload[i.dataset.post] = val;
            i.disabled = true;
        }
    });
    await fetch(`${apiPost}/${id}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    btn.textContent = 'Edit Post';
    initPosts();
}

document.getElementById('add-post-form').onsubmit = async (e) => {
    e.preventDefault();
    const payload = {
        title: post_title.value, 
        slug: post_slug_hidden.value, // Auto-generated
        content: post_content.value,
        blog_category_id: parseInt(post_category_select.value),
        author_user_id: CURRENT_USER_ID,
        is_published: post_status.value === 'true',
        featured_image_url: post_f_img.value,
        published_at: Date.parse(post_date.value) || Date.now(),
        created_at: Date.now()
    };
    await fetch(apiPost, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    e.target.reset();
    initPosts();
};

async function deletePost(id) {
    if(confirm('Delete post?')) { await fetch(`${apiPost}/${id}`, { method: 'DELETE' }); initPosts(); }
}

/* ---------- Gallery & Analytics & Search (Same as before) ---------- */
async function loadGallery(postId) {
    const res = await fetch(`${apiImg}?blog_post_id=${postId}`);
    const imgs = await res.json();
    const cont = document.getElementById(`gal-${postId}`);
    cont.innerHTML = imgs.length ? '' : '<small>No images</small>';
    imgs.forEach(img => {
        const d = document.createElement('div');
        d.className = 'gallery-item';
        d.innerHTML = `<img src="${img.image_url}"><button class="del-img" onclick="deleteImg(${img.id},${postId})">Ã—</button>`;
        cont.appendChild(d);
    });
}
async function addImg(postId) {
    const url = document.getElementById(`img-url-${postId}`).value;
    if(!url) return;
    await fetch(apiImg, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ blog_post_id: postId, image_url: url, created_at: Date.now() }) });
    loadGallery(postId);
}
async function deleteImg(imgId, postId) {
    await fetch(`${apiImg}/${imgId}`, { method: 'DELETE' });
    loadGallery(postId);
}
async function fetchAnalytics() {
    const res = await fetch(apiAnalytics);
    const data = await res.json();
    document.getElementById('analytics-table-body').innerHTML = data.map(a => `
        <tr>
            <td>${new Date(a.created_at).toLocaleDateString()}</td>
            <td>#${a.blog_post_id}</td>
            <td>${a.ip_address}</td>
            <td>${a.referrer || 'None'}</td>
            <td><small>${a.user_agent.substring(0,30)}...</small></td>
        </tr>
    `).join('');
}
function handleSearch() {
    const v = document.getElementById('searchInput').value.toLowerCase();
    filteredPosts = allPosts.filter(p => p.title.toLowerCase().includes(v));
    currentPage = 1; renderPosts();
}
function renderPagination() {
    const p = document.getElementById('pagination');
    p.innerHTML = '';
    const total = Math.ceil(filteredPosts.length / PAGE_SIZE);
    for(let i=1; i<=total; i++) {
        const b = document.createElement('button');
        b.className = 'page-btn' + (i===currentPage?' active':'');
        b.textContent = i;
        b.onclick = () => { currentPage = i; renderPosts(); };
        p.appendChild(b);
    }
}

initPosts();
</script>
</body>
</html>
