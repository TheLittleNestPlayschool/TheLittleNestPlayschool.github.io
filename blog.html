<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Blog Admin & Analytics Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
:root{--max-width:1400px;--gap:10px; --primary: #74e8e8; --secondary: #498787; --bg: #e8ffff; --input-bg: #ffeffb;}

body{
  font-family:Arial,Helvetica,sans-serif;
  margin:16px auto;
  padding:18px;
  max-width:var(--max-width);
  font-size:15px;
  background-color:var(--bg);
}

/* ---------- Tab Switcher ---------- */
.tab-nav {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 10px;
}
.tab-btn {
    padding: 10px 20px;
    background: #fff;
    border: 1px solid var(--primary);
    cursor: pointer;
    border-radius: 4px;
    font-weight: bold;
}
.tab-btn.active {
    background: var(--primary);
    color: #000;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ---------- Layout & Fields ---------- */
form .record-line{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-bottom:10px
}
.record-field{
  display:flex;
  flex-direction:column
}

input,textarea,select{
  padding:8px;
  font-size:14px;
  box-sizing:border-box;
  background-color:var(--input-bg);
  border:1px solid #ccc;
  border-radius:4px;
  width:100%;
}

textarea{min-height:56px; resize:vertical}

button{
  padding:8px 12px;
  font-size:14px;
  background-color:var(--primary);
  border:none;
  border-radius:4px;
  cursor:pointer;
  transition:0.2s;
}
button:hover{
  background-color:var(--secondary);
  color:#fff;
}

/* ---------- Gallery Styles ---------- */
.gallery-section {
    background: #fff5fd;
    padding: 12px;
    margin-top: 10px;
    border-radius: 6px;
    border: 1px dashed var(--primary);
}
.gallery-grid {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 10px;
    min-height: 50px;
}
.gallery-item {
    width: 90px;
    position: relative;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: white;
    padding: 2px;
}
.gallery-item img {
    width: 100%;
    height: 60px;
    object-fit: cover;
    border-radius: 2px;
}
.del-img {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ff4d4d;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
}

/* ---------- Table Styles ---------- */
#tableWrapper{
  max-height:700px;
  overflow-y:auto;
  border:1px solid #ddd;
  padding:8px;
  border-radius:6px;
  background:#fff;
}
table{ width:100%; border-collapse:collapse; table-layout:fixed; }
th,td{ border:1px solid #e6e6e6; padding:10px; vertical-align:top; font-size:13px; }
.record-line-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:6px; }
.record-field label{ font-size:11px; font-weight: bold; color:#555; margin-bottom:4px }
.actions button{ display:block; width:90px; margin:6px auto; }

.pagination{ display:flex; gap:6px; justify-content:center; margin-top:12px; }
.page-btn{ padding:6px 10px; border:1px solid #ccc; background:var(--primary); cursor:pointer; border-radius:4px }
.page-btn.active{background:var(--secondary); color:#fff;}

@media (max-width:1200px){
  .record-line-grid, form .record-line{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('posts')">Blog Posts</button>
    <button class="tab-btn" onclick="switchTab('categories')">Categories</button>
    <button class="tab-btn" onclick="switchTab('analytics')">Analytics</button>
</div>

<div id="posts" class="tab-content active">
    <h2>Create New Blog Post</h2>
    <form id="add-form" autocomplete="off">
      <div class="record-line">
        <div class="record-field"><label>Title</label><input type="text" id="title" required></div>
        <div class="record-field"><label>Slug</label><input type="text" id="slug" required></div>
        <div class="record-field">
            <label>Category</label>
            <select id="blog_category_id_select" required></select>
        </div>
        <div class="record-field"><label>Author</label><input type="text" id="author_display" value="Current User" disabled></div>
      </div>
      <div class="record-line">
        <div class="record-field" style="grid-column: span 2;"><label>Featured Image URL</label><input type="text" id="featured_image_url"></div>
        <div class="record-field">
          <label>Status</label>
          <select id="is_published">
            <option value="true">Published</option>
            <option value="false" selected>Draft</option>
          </select>
        </div>
        <div class="record-field"><label>Publish Date</label><input type="date" id="published_at"></div>
      </div>
      <div class="record-field" style="margin-bottom:10px;">
        <label>Post Content</label>
        <textarea id="content" style="min-height:100px"></textarea>
      </div>
      <button type="submit" style="width:160px;">Add Post</button>
    </form>

    <div style="margin: 20px 0; display: flex; gap: 10px;">
        <input id="searchInput" placeholder="Search titles..." style="flex:1" />
    </div>

    <div id="tableWrapper">
        <table id="records-table">
            <thead>
                <tr><th style="width:40px">ID</th><th>Post Editor & Gallery</th><th style="width:110px">Actions</th></tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
    <div class="pagination" id="pagination"></div>
</div>

<div id="categories" class="tab-content">
    <h2>Blog Categories</h2>
    <div id="tableWrapper">
        <table>
            <thead><tr><th>ID</th><th>Name</th><th>Slug</th><th>Status</th></tr></thead>
            <tbody id="category-table-body"></tbody>
        </table>
    </div>
</div>

<div id="analytics" class="tab-content">
    <h2>Traffic Audit Log (Read-Only)</h2>
    <div id="tableWrapper">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Post ID</th>
                    <th>IP Address</th>
                    <th>Referrer</th>
                    <th>User Agent</th>
                </tr>
            </thead>
            <tbody id="analytics-table-body"></tbody>
        </table>
    </div>
</div>

<script>
/* ---------- Configuration ---------- */
const CURRENT_USER_ID = 1; // Replace with dynamic ID after login integration
const apiBase = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_post";
const imgApi = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_image";
const catApi = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_category";
const analyticsApi = "https://x8ki-letl-twmt.n7.xano.io/api:zmxHunN9/blog_analytics";

let PAGE_SIZE = 10;
let allRecords = [];
let filteredRecords = [];
let categories = [];
let currentPage = 1;

/* ---------- Tab Switcher Logic ---------- */
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
    
    if(tabId === 'categories') fetchCategories();
    if(tabId === 'analytics') fetchAnalytics();
    if(tabId === 'posts') fetchAllRecords();
}

/* ---------- Core Data Fetching ---------- */
async function fetchCategories(){
    const res = await fetch(catApi);
    categories = await res.json();
    renderCategoryDropdown();
    renderCategoryTable();
}

async function fetchAnalytics(){
    const res = await fetch(analyticsApi);
    const data = await res.json();
    const tbody = document.getElementById('analytics-table-body');
    tbody.innerHTML = data.map(a => `
        <tr>
            <td>${new Date(a.created_at).toLocaleString()}</td>
            <td>Post #${a.blog_post_id}</td>
            <td>${a.ip_address}</td>
            <td>${a.referrer || 'Direct'}</td>
            <td style="font-size:10px">${a.user_agent}</td>
        </tr>
    `).join('');
}

async function fetchAllRecords(){
    if(categories.length === 0) await fetchCategories();
    const res = await fetch(apiBase);
    const data = await res.json();
    allRecords = Array.isArray(data) ? data : data.items || [];
    filteredRecords = [...allRecords];
    renderPage();
    renderPagination();
}

/* ---------- Rendering Helpers ---------- */
function renderCategoryDropdown(){
    const select = document.getElementById('blog_category_id_select');
    select.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function renderCategoryTable(){
    const tbody = document.getElementById('category-table-body');
    tbody.innerHTML = categories.map(c => `
        <tr>
            <td>${c.id}</td>
            <td><strong>${c.name}</strong></td>
            <td>${c.slug}</td>
            <td>${c.is_active ? '✅ Active' : '❌ Inactive'}</td>
        </tr>
    `).join('');
}

function renderPage(){
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = '';
  let start = (currentPage-1) * PAGE_SIZE;
  let end = Math.min(start + PAGE_SIZE, filteredRecords.length);

  for(let i=start; i<end; i++){
    const r = filteredRecords[i];
    const tr = document.createElement('tr');
    const galleryId = `gallery-${r.id}`;

    tr.innerHTML = `
      <td>${r.id}</td>
      <td>
        <div class="record-line-grid">
          <div class="record-field"><label>Title</label><input data-field="title" value="${r.title||''}" disabled></div>
          <div class="record-field"><label>Slug</label><input data-field="slug" value="${r.slug||''}" disabled></div>
          <div class="record-field">
            <label>Status</label>
            <select data-field="is_published" disabled>
              <option value="true" ${r.is_published?'selected':''}>Published</option>
              <option value="false" ${!r.is_published?'selected':''}>Draft</option>
            </select>
          </div>
          <div class="record-field">
            <label>Category</label>
            <select data-field="blog_category_id" disabled>
                ${categories.map(c => `<option value="${c.id}" ${c.id === r.blog_category_id ? 'selected' : ''}>${c.name}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="record-field">
          <label>Content</label>
          <textarea data-field="content" disabled>${r.content||''}</textarea>
        </div>
        <div class="gallery-section">
          <label>Gallery</label>
          <div class="gallery-grid" id="${galleryId}">Loading...</div>
          <div style="margin-top:8px; display:flex; gap:5px;">
             <input type="text" id="in-url-${r.id}" placeholder="Paste URL" style="flex:2">
             <button onclick="addImage(${r.id})">Add</button>
          </div>
        </div>
      </td>
      <td class="actions">
        <button onclick="editRow(this,${r.id})">Edit Post</button>
        <button onclick="deleteRow(${r.id})" style="background:#ffb3b3">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
    loadGallery(r.id, galleryId);
  }
}

/* ---------- CRUD Logic (Simplified for brevity) ---------- */
async function editRow(btn, id){
  const tr = btn.closest('tr');
  const inputs = tr.querySelectorAll('input, select, textarea');
  if(btn.textContent === 'Edit Post'){
    inputs.forEach(i => i.disabled = false);
    btn.textContent = 'Save';
    return;
  }
  const payload = {};
  inputs.forEach(i => {
    if(i.dataset.field){
      payload[i.dataset.field] = (i.dataset.field==='is_published') ? (i.value==='true') : 
                                 (i.dataset.field==='blog_category_id') ? parseInt(i.value) : i.value;
      i.disabled = true;
    }
  });
  await fetch(`${apiBase}/${id}`, {
    method: 'PATCH',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  btn.textContent = 'Edit Post';
  fetchAllRecords();
}

async function addImage(postId) {
  const url = document.getElementById(`in-url-${postId}`).value;
  if(!url) return;
  await fetch(imgApi, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ blog_post_id: postId, image_url: url, created_at: Date.now() })
  });
  loadGallery(postId, `gallery-${postId}`);
}

async function loadGallery(postId, containerId) {
  const res = await fetch(`${imgApi}?blog_post_id=${postId}`);
  const images = await res.json();
  const container = document.getElementById(containerId);
  container.innerHTML = images.length ? '' : '<span style="color:#999">No images.</span>';
  images.forEach(img => {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.innerHTML = `<img src="${img.image_url}"><button class="del-img" onclick="deleteImage(${img.id},${postId},'${containerId}')">×</button>`;
    container.appendChild(div);
  });
}

async function deleteImage(imgId, postId, containerId) {
  await fetch(`${imgApi}/${imgId}`, { method: 'DELETE' });
  loadGallery(postId, containerId);
}

async function deleteRow(id){
  if(confirm('Delete post?')){
    await fetch(`${apiBase}/${id}`, {method:'DELETE'});
    fetchAllRecords();
  }
}

document.getElementById('add-form').onsubmit = async e => {
  e.preventDefault();
  const payload = {
    title: title.value,
    slug: slug.value,
    content: content.value,
    blog_category_id: parseInt(document.getElementById('blog_category_id_select').value),
    author_user_id: CURRENT_USER_ID, // Automatically assigned
    is_published: is_published.value === 'true',
    featured_image_url: featured_image_url.value,
    published_at: Date.parse(published_at.value) || Date.now(),
    created_at: Date.now()
  };
  await fetch(apiBase, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  e.target.reset();
  fetchAllRecords();
};

/* ---------- Pagination & Search ---------- */
document.getElementById('searchInput').oninput = () => {
  const v = searchInput.value.toLowerCase();
  filteredRecords = allRecords.filter(r => (r.title||'').toLowerCase().includes(v));
  currentPage = 1; renderPage(); renderPagination();
};

function renderPagination(){
  const p = document.getElementById('pagination');
  p.innerHTML = '';
  const pages = Math.ceil(filteredRecords.length / PAGE_SIZE);
  for(let i=1; i<=pages; i++){
    const b = document.createElement('button');
    b.textContent = i; b.className = 'page-btn' + (i===currentPage?' active':'');
    b.onclick = () => { currentPage=i; renderPage(); renderPagination(); };
    p.appendChild(b);
  }
}

// Initial Load
fetchAllRecords();
</script>
</body>
</html>
