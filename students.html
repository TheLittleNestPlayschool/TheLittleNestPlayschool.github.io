<style>
    /* Consistent Branding & Typography */
    .nest-header { font-family: 'Georgia', serif; color: #1a365d; }
    .nest-table { width: 100%; border-collapse: collapse; background: white; border: 1px solid #e2e8f0; }
    .nest-table th { background: #f8fafc; padding: 12px; font-size: 0.75rem; color: #475569; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; text-align: left; }
    
    /* FIX: Standardized weight to match Manner Topic columns */
    .nest-table td { 
        padding: 12px; 
        border-bottom: 1px solid #f1f5f9; 
        font-size: 0.85rem; 
        color: #333; 
        vertical-align: middle; 
        font-weight: 400 !important; 
    }
    
    .status-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 700; }
    .btn-teal { background-color: #00d1b2; color: white; padding: 8px 16px; border-radius: 4px; font-weight: 900; border: none; cursor: pointer; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; }
    .btn-gray { background-color: #94a3b8; color: white; padding: 8px 16px; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; }
    
    .action-edit { color: blue; font-weight: 700; cursor: pointer; font-size: 0.8rem; text-decoration: none; }
    .action-del { color: red; font-weight: 700; cursor: pointer; font-size: 0.8rem; text-decoration: none; }
    
    .nest-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
    .nest-modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 4px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    
    label { display: block; font-size: 0.7rem; font-weight: bold; color: #64748b; text-transform: uppercase; margin-bottom: 4px; margin-top: 15px; }
    input, select { width: 100%; border: 1px solid #cbd5e1; padding: 10px; border-radius: 4px; font-size: 0.9rem; box-sizing: border-box; }
</style>

<div class="max-w-7xl mx-auto p-6">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 class="text-5xl nest-header">Student Management</h1>
        <button onclick="openModal()" class="btn-teal">+ NEW STUDENT</button>
    </div>

    <div class="bg-white rounded shadow-sm border border-gray-200">
        <table class="nest-table">
            <thead>
                <tr>
                    <th style="width: 60px;">ID</th>
                    <th>Name</th>
                    <th>Parent / Guardian</th>
                    <th>Date of Birth</th>
                    <th style="width: 100px;">Status</th>
                    <th>Franchise</th>
                    <th style="text-align: center; width: 120px;">Actions</th>
                </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
        </table>
    </div>
</div>

<div id="studentModal" class="nest-modal">
    <div class="nest-modal-content">
        <h2 id="modalTitle" class="text-3xl nest-header" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Manage Student</h2>
        <form id="studentForm">
            <input type="hidden" id="studentId">
            <label>Student Name</label>
            <input type="text" id="name" required>
            <label>Date of Birth</label>
            <input type="date" id="date_of_birth">
            <label>Parent / Guardian</label>
            <select id="parent_id" required>
                <option value="">Select a Parent...</option>
            </select>
            <div style="margin-top: 20px; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="is_active" style="width: auto;" checked>
                <label style="margin: 0; font-size: 0.8rem; font-weight: bold; color: #4a5568;">ACTIVE STUDENT</label>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <button type="button" onclick="closeModal()" class="btn-gray">CANCEL</button>
                <button type="submit" class="btn-teal">SAVE STUDENT</button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const STUDENT_API = "https://x8ki-letl-twmt.n7.xano.io/api:iEHfqd-N/student";
    const PARENT_API = "https://x8ki-letl-twmt.n7.xano.io/api:iEHfqd-N/parent";
    const FRANCHISE_API = "https://x8ki-letl-twmt.n7.xano.io/api:mXEfdJlg/franchise";

    let parentDataStore = {}; 
    let franchiseMap = {};

    window.openModal = function() { document.getElementById('studentModal').style.display = 'block'; }
    window.closeModal = function() { 
        document.getElementById('studentModal').style.display = 'none'; 
        document.getElementById('studentForm').reset();
        document.getElementById('studentId').value = '';
    }

    async function loadResources() {
        try {
            const [pRes, fRes] = await Promise.all([fetch(PARENT_API), fetch(FRANCHISE_API)]);
            const [parents, franchises] = await Promise.all([pRes.json(), fRes.json()]);
            
            const pSelect = document.getElementById('parent_id');
            pSelect.innerHTML = '<option value="">Select a Parent...</option>';
            parents.forEach(p => {
                parentDataStore[p.id] = p;
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.first_name} ${p.last_name}`;
                pSelect.appendChild(opt);
            });

            franchises.forEach(f => franchiseMap[f.id] = f.name || `Franchise #${f.id}`);
            loadStudents();
        } catch (e) { console.error("Load Error", e); }
    }

    window.loadStudents = async function() {
        try {
            const res = await fetch(STUDENT_API);
            const data = await res.json();
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = data.map(s => `
                <tr>
                    <td style="color: #94a3b8;">${s.id}</td>
                    <td>${s.name}</td>
                    <td>${parentDataStore[s.parent_id] ? parentDataStore[s.parent_id].first_name + ' ' + parentDataStore[s.parent_id].last_name : '---'}</td>
                    <td>${s.date_of_birth ? new Date(s.date_of_birth).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <span class="status-badge" style="background: ${s.is_active ? '#e6fffa' : '#fff5f5'}; color: ${s.is_active ? '#2c7a7b' : '#c53030'};">
                            ${s.is_active ? 'ACTIVE' : 'INACTIVE'}
                        </span>
                    </td>
                    <td>${franchiseMap[s.franchise_id] || s.franchise_id}</td>
                    <td style="text-align: center;">
                        <span onclick="editStudent(${s.id})" class="action-edit">Edit</span> 
                        <span style="color: #ddd; margin: 0 4px;">|</span> 
                        <span onclick="deleteStudent(${s.id})" class="action-del">Del</span>
                    </td>
                </tr>
            `).join('');
        } catch (e) { console.error("Fetch Error", e); }
    }

    window.editStudent = async function(id) {
        const res = await fetch(`${STUDENT_API}/${id}`);
        const s = await res.json();
        document.getElementById('studentId').value = s.id;
        document.getElementById('name').value = s.name;
        document.getElementById('date_of_birth').value = s.date_of_birth ? new Date(s.date_of_birth).toISOString().split('T')[0] : '';
        document.getElementById('parent_id').value = s.parent_id;
        document.getElementById('is_active').checked = s.is_active;
        openModal();
    }

    document.getElementById('studentForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('studentId').value;
        const pId = parseInt(document.getElementById('parent_id').value);
        const payload = {
            name: document.getElementById('name').value,
            date_of_birth: document.getElementById('date_of_birth').value,
            parent_id: pId,
            franchise_id: parentDataStore[pId] ? parentDataStore[pId].franchise_id : 0,
            is_active: document.getElementById('is_active').checked
        };
        await fetch(id ? `${STUDENT_API}/${id}` : STUDENT_API, {
            method: id ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        closeModal();
        loadStudents();
    };

    window.deleteStudent = async function(id) {
        if(confirm('Delete?')) { await fetch(`${STUDENT_API}/${id}`, {method: 'DELETE'}); loadStudents(); }
    };

    loadResources();
})();
</script>
