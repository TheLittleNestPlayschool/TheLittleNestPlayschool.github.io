<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0;">Franchise Manager</h1>
    <button onclick="openNewFranchiseModal()" style="background:#00d1b2; color:white; border:none; padding:12px 24px; cursor:pointer; font-weight:bold; border-radius:4px;">+ NEW FRANCHISE</button>
</div>

<div id="franchise-container" style="display: flex; flex-direction: column; gap: 20px;">
    <div id="loading-indicator" style="text-align:center; padding:50px; border:1px solid #eee;">Syncing Franchise Data...</div>
</div>

<div id="modal-franchise" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:white; width:1000px; border-radius:8px; display:flex; flex-direction:column; max-height:95vh;">
        <div style="padding:20px; border-bottom:1px solid #eee; background:#f9f9f9;">
            <h3 style="margin:0;">Franchise Profile Editor</h3>
        </div>
        <div style="padding:25px; overflow-y:auto; flex-grow:1;">
            <input type="hidden" id="f-id">
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px;">
                <div style="grid-column: span 2;"><label>Franchise Name</label><input type="text" id="f-name" style="width:100%; padding:8px;"></div>
                <div><label>Status</label>
                    <select id="f-status" style="width:100%; padding:8px;">
                        <option value="active">active</option>
                        <option value="on_hold">on_hold</option>
                        <option value="closed">closed</option>
                        <option value="pending_opening">pending_opening</option>
                    </select>
                </div>
            </div>
            </div>
        <div style="padding:20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px; background:#f9f9f9;">
            <button onclick="document.getElementById('modal-franchise').style.display='none'">CANCEL</button>
            <button onclick="submitFranchise()" style="background:#00d1b2; color:white; border:none; padding:10px 25px; cursor:pointer; font-weight:bold; border-radius:4px;">SAVE RECORD</button>
        </div>
    </div>
</div>

<script>
    // Constants [cite: 2025-12-29]
    const F_API = 'https://x8ki-letl-twmt.n7.xano.io/api:mXEfdJlg/franchise';
    const fields = [
        'name', 'address', 'phone_number', 'royalty_rate', 'owner_1_name', 'owner_1_phone', 'owner_1_email',
        'owner_2_name', 'owner_2_phone', 'owner_2_email', 'franchise_email', 'status', 'opening_date',
        'business_tax_id', 'internal_notes', 'social_fb', 'social_ig', 'social_li', 'social_tiktok'
    ];

    // Global load function [cite: 2025-12-29]
    async function loadFranchises() {
        const container = document.getElementById('franchise-container');
        if (!container) return;

        try {
            const res = await fetch(F_API + '?t=' + Date.now());
            if (!res.ok) throw new Error("API Connection Failed");

            const data = await res.json();
            let list = Array.isArray(data) ? data : (data.items || []);
            list.sort((a, b) => a.id - b.id);
            
            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">No Franchise Records Found.</div>';
                return;
            }

            container.innerHTML = list.map(f => {
                const s = (val) => val ? '<span style="color:green;">✅</span>' : '<span style="color:red;">❌</span>';
                return `
                <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; border-bottom:2px solid #00d1b2; padding-bottom:10px; margin-bottom:10px;">
                        <h2 style="margin:0;">${f.name || 'N/A'}</h2>
                        <span style="font-weight:bold; color:#00d1b2; text-transform:uppercase; font-size:0.8rem;">${(f.status || '').replace('_',' ')}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; font-size:0.85rem;">
                        <div><span style="color:#888; font-weight:bold; font-size:0.7rem;">FRANCHISE BRAND</span><br>E: ${f.franchise_email || 'N/A'}</div>
                        <div><span style="color:#888; font-weight:bold; font-size:0.7rem;">OWNER 1</span><br>${f.owner_1_name || 'N/A'}</div>
                        <div><span style="color:#888; font-weight:bold; font-size:0.7rem;">OPERATIONS</span><br>Tax ID: ${f.business_tax_id || 'N/A'}</div>
                        <div style="text-align:right;">
                            <button onclick="editFranchise(${f.id})" style="color:blue; border:none; background:none; cursor:pointer;">Edit</button>
                            <button onclick="deleteFranchise(${f.id})" style="color:red; border:none; background:none; cursor:pointer; margin-left:10px;">Delete</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { 
            console.error("Xano Fetch Error:", e);
            container.innerHTML = `<div style="text-align:center; color:red; padding:20px;">Error: ${e.message}</div>`;
        }
    }

    // Modal and Submit functions [cite: 2025-12-29]
    function openNewFranchiseModal() {
        document.getElementById('f-id').value = "";
        fields.forEach(f => {
            const el = document.getElementById('f-' + f);
            if(el) el.value = "";
        });
        document.getElementById('modal-franchise').style.display = 'flex';
    }

    async function submitFranchise() {
        const id = document.getElementById('f-id').value;
        const payload = {};
        fields.forEach(f => {
            const el = document.getElementById('f-' + f);
            if(el) payload[f] = el.value || "";
        });

        const url = id ? `${F_API}/${id}` : F_API;
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            document.getElementById('modal-franchise').style.display = 'none';
            loadFranchises();
        }
    }

    // Trigger initial load [cite: 2025-12-29]
    window.onload = loadFranchises;
</script>
