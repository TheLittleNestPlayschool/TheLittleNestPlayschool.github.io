<!DOCTYPE html>
 
<html lang="en">
<head>
    <meta charset="UTF-8">
   <title>Franchise Manager</title>
    <style>
        body { font-family: 'Inter', sans-serif; color: #333; padding: 20px; background: #fff; line-height: 1.5; }
        label { display: block; font-size: 0.75rem; font-weight: bold; color: #666; margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea { border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; border-bottom: 2px solid #00d1b2; padding-bottom: 10px; margin-bottom: 15px; }
        .btn-new { background:#00d1b2; color:#1a1a1a; border:none; padding:12px 24px; cursor:pointer; font-weight:bold; border-radius:4px; }
    </style>
</head>
<body>
 
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0; font-family: Georgia, serif; color: #1a365d;">Franchise Manager</h1>
    <button onclick="openNewFranchiseModal()" class="btn-new">+ NEW FRANCHISE</button>
</div>
 
<div id="franchise-container">
    <div style="text-align:center; padding:50px; border:1px solid #eee; border-radius: 8px;">Syncing Franchise Data...</div>
</div>
 
<div id="modal-franchise" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:white; width:1000px; border-radius:8px; display:flex; flex-direction:column; max-height:95vh;">
        <div style="padding:20px; border-bottom:1px solid #eee; background:#f9f9f9;">
            <h3 style="margin:0;">Franchise Profile Editor</h3>
        </div>
        <div style="padding:25px; overflow-y:auto; flex-grow:1;">
            <input type="hidden" id="f-id">
            <h4 style="border-bottom:2px solid #00d1b2; padding-bottom:5px; margin-top:0;">1. Franchise & Brand Information</h4>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px;">
               <div style="grid-column: span 2;"><label>Franchise Name</label><input type="text" id="f-name"></div>
               <div><label>Status</label>
                   <select id="f-status">
                       <option value="active">active</option>
                       <option value="on_hold">on_hold</option>
                       <option value="closed">closed</option>
                       <option value="pending_opening">pending_opening</option>
                   </select>
               </div>
               <div style="grid-column: span 3;"><label>Full Address</label><input type="text" id="f-address"></div>
               <div><label>Main Phone</label><input type="text" id="f-phone_number"></div>
               <div><label>Franchise Email</label><input type="email" id="f-franchise_email"></div>
               <div><label>Royalty Rate (%)</label><input type="number" id="f-royalty_rate" step="0.01"></div>
            </div>
            <h4 style="border-bottom:2px solid #00d1b2; padding-bottom:5px;">2. Owners & Socials</h4>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
               <div><label>Owner 1</label><input type="text" id="f-owner_1_name"></div>
               <div><label>Owner 2</label><input type="text" id="f-owner_2_name"></div>
               <div><label>FB</label><input type="text" id="f-social_fb"></div>
            </div>
            <label style="margin-top:10px;">Internal Notes</label>
           <textarea id="f-internal_notes" style="width:100%; height:60px; border:1px solid #ccc; border-radius:4px;"></textarea>
        </div>
        <div style="padding:20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px; background:#f9f9f9;">
            <button onclick="document.getElementById('modal-franchise').style.display='none'">CANCEL</button>
            <button onclick="submitFranchise()" style="background:#00d1b2; padding:10px 25px; border:none; cursor:pointer; font-weight:bold; border-radius:4px;">SAVE RECORD</button>
        </div>
    </div>
</div>
 
<script>
    const F_API = 'https://x8ki-letl-twmt.n7.xano.io/api:mXEfdJlg/franchise';
    // List matches your table structure
    const fields = ['name', 'address', 'phone_number', 'royalty_rate', 'owner_1_name', 'owner_1_phone', 'owner_1_email', 'owner_2_name', 'owner_2_phone', 'owner_2_email', 'franchise_email', 'status', 'opening_date', 'business_tax_id', 'internal_notes', 'social_fb', 'social_ig', 'social_li', 'social_tiktok'];
 
    async function loadFranchises() {
        const container = document.getElementById('franchise-container');
        try {
            const res = await fetch(F_API + '?t=' + Date.now());
            const data = await res.json();
            
            let list = [];
            if (Array.isArray(data)) {
                list = data;
            } else if (data.items && Array.isArray(data.items)) {
                list = data.items;
            } else if (data.franchise && Array.isArray(data.franchise)) {
                list = data.franchise;
            } else {
                const arrayKey = Object.keys(data).find(key => Array.isArray(data[key]));
                list = arrayKey ? data[arrayKey] : [];
            }
 
            if (list.length === 0) {
               container.innerHTML = '<div style="text-align:center; padding:50px; border:1px solid #eee;">No Records Found.</div>';
               return;
            }
 
           list.sort((a, b) => a.id - b.id);
           container.innerHTML = list.map(f => {
                return `
               <div class="card">
                   <div class="card-header">
                       <h2 style="margin:0; font-size:1.1rem;">${f.name || 'N/A'}</h2>
                       <span style="font-weight:900; color:#00d1b2; text-transform:uppercase; font-size:0.7rem;">${(f.status || '').replace('_',' ')}</span>
                   </div>
                   <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; font-size:0.85rem;">
                       <div><label>Contact</label>E: ${f.franchise_email || 'N/A'}<br>P: ${f.phone_number || 'N/A'}</div>
                       <div><label>Owners</label>1: ${f.owner_1_name || 'N/A'}<br>2: ${f.owner_2_name || 'N/A'}</div>
                       <div><label>Financial</label>Rate: ${f.royalty_rate}%<br>Tax ID: ${f.business_tax_id || 'N/A'}</div>
                       <div style="text-align:right;">
                           <button onclick="editFranchise(${f.id})" style="color:blue; border:1px solid blue; background:none; cursor:pointer; font-weight:bold; border-radius:4px; padding:4px 10px;">EDIT</button>
                           <button onclick="deleteFranchise(${f.id})" style="color:red; border:1px solid red; background:none; cursor:pointer; font-weight:bold; border-radius:4px; padding:4px 10px; margin-left:5px;">DEL</button>
                       </div>
                   </div>
               </div>`;
           }).join('');
            
        } catch(e) {
           container.innerHTML = "Error: " + e.message;
        }
    }
 
    async function submitFranchise() {
        const id = document.getElementById('f-id').value;
        const innerData = {};
        
        fields.forEach(f => {
            const el = document.getElementById('f-' + f);
            if(el) {
                // Handle decimals correctly for Xano
                innerData[f] = (f === 'royalty_rate') ? (parseFloat(el.value) || 0) : (el.value || "");
            }
        });

        // Nest data inside 'franchise' to match Xano API setup [cite: 2025-12-29]
        const payload = { franchise: innerData };

        const url = id ? `${F_API}/${id}` : F_API;
        const method = id ? 'PATCH' : 'POST';
        
        try {
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (res.ok) {
               document.getElementById('modal-franchise').style.display = 'none';
               loadFranchises();
            }
        } catch (err) {
            console.error("Save failed:", err);
        }
    }
 
    async function editFranchise(id) {
        try {
            const res = await fetch(`${F_API}/${id}`);
            const data = await res.json();
            
            // Extract the specific franchise object from the response [cite: 2025-12-29]
            const f = data.id ? data : (data.franchise || data.item || data);
 
           document.getElementById('f-id').value = f.id;
           fields.forEach(field => {
                const el = document.getElementById('f-' + field);
                if(el) {
                   el.value = (f[field] !== undefined && f[field] !== null) ? f[field] : "";
                }
            });
           document.getElementById('modal-franchise').style.display = 'flex';
        } catch (e) {
           console.error("Edit failed:", e);
        }
    }
 
    async function deleteFranchise(id) {
       if(confirm("Permanent Delete?")) {
            await fetch(`${F_API}/${id}`, { method: 'DELETE' });
            loadFranchises();
        }
    }
 
    function openNewFranchiseModal() {
       document.getElementById('f-id').value = "";
       fields.forEach(f => {
            const el = document.getElementById('f-' + f);
            if(el) el.value = "";
        });
       document.getElementById('modal-franchise').style.display = 'flex';
    }
 
    loadFranchises();
</script>
</body>
</html>
