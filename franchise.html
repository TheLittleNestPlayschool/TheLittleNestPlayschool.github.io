<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0;">Franchise Manager</h1>
    <button onclick="openNewFranchiseModal()" style="background:#00d1b2; color:white; border:none; padding:12px 24px; cursor:pointer; font-weight:bold; border-radius:4px;">+ NEW FRANCHISE</button>
</div>

<div id="franchise-container" style="display: flex; flex-direction: column; gap: 20px;">
    <div style="text-align:center; padding:50px; border:1px solid #eee;">Syncing Franchise Data...</div>
</div>

<div id="modal-franchise" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:white; width:850px; border-radius:8px; display:flex; flex-direction:column; max-height:90vh;">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
            <h3 style="margin:0;">Franchise Profile Editor</h3>
            <button onclick="document.getElementById('modal-franchise').style.display='none'" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div style="padding:25px; overflow-y:auto; flex-grow:1; display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <input type="hidden" id="f-id">
            
            <div style="grid-column: span 2;"><label>Franchise Name</label><input type="text" id="f-name" style="width:100%; padding:8px;"></div>
            <div><label>Location/Area</label><input type="text" id="f-location" style="width:100%; padding:8px;"></div>
            <div><label>Contact Number</label><input type="text" id="f-contact_number" style="width:100%; padding:8px;"></div>
            <div><label>Contact Email</label><input type="email" id="f-contact_email" style="width:100%; padding:8px;"></div>
            <div><label>Status</label>
                <select id="f-status" style="width:100%; padding:8px;">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div><label>Opening Date</label><input type="date" id="f-opening_date" style="width:100%; padding:8px;"></div>
            <div><label>Franchise Fee Paid</label><input type="number" id="f-fee_paid" style="width:100%; padding:8px;"></div>
            <div style="grid-column: span 2;"><label>Full Address</label><textarea id="f-address" style="width:100%; height:60px; padding:8px;"></textarea></div>
            <div style="grid-column: span 2;"><label>Admin Notes</label><textarea id="f-notes" style="width:100%; height:60px; padding:8px;"></textarea></div>
        </div>
        <div style="padding:20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px;">
            <button onclick="document.getElementById('modal-franchise').style.display='none'">CANCEL</button>
            <button onclick="submitFranchise()" style="background:#00d1b2; color:white; border:none; padding:10px 25px; cursor:pointer; font-weight:bold; border-radius:4px;">SAVE ALL FIELDS</button>
        </div>
    </div>
</div>

<script>
(function() {
    const F_API = 'https://x8ki-letl-twmt.n7.xano.io/api:mXEfdJlg/franchise';
    // Internal field tracker to ensure 1:1 sync with Xano
    const fields = ['name', 'location', 'contact_number', 'contact_email', 'status', 'address', 'opening_date', 'fee_paid', 'notes'];

    window.loadFranchises = async () => {
        try {
            const res = await fetch(F_API + '?t=' + Date.now());
            const data = await res.json();
            const list = Array.isArray(data) ? data : (data.items || []);
            
            document.getElementById('franchise-container').innerHTML = list.map(f => `
                <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; border-bottom:2px solid #00d1b2; padding-bottom:10px; margin-bottom:10px;">
                        <h2 style="margin:0;">${f.name}</h2>
                        <span style="font-weight:bold; color:${f.status === 'active' ? 'green' : 'red'}; text-transform:uppercase;">${f.status}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:15px; font-size:0.9rem;">
                        <div>
                            <b>Contact:</b><br>${f.contact_email || 'N/A'}<br>${f.contact_number || 'N/A'}
                        </div>
                        <div>
                            <b>Details:</b><br>Loc: ${f.location || 'N/A'}<br>Opened: ${f.opening_date || 'N/A'}
                        </div>
                        <div>
                            <b>Financials/Notes:</b><br>Fee: ${f.fee_paid || '0'}<br>Notes: ${f.notes || 'None'}
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:15px; border-top:1px solid #f9f9f9; padding-top:10px;">
                        <button onclick="editFranchise(${f.id})" style="color:blue; border:1px solid blue; background:none; padding:5px 12px; cursor:pointer; font-weight:bold; border-radius:4px;">EDIT FULL RECORD</button>
                        <button onclick="deleteFranchise(${f.id})" style="color:red; border:1px solid red; background:none; padding:5px 12px; cursor:pointer; font-weight:bold; border-radius:4px;">DELETE</button>
                    </div>
                </div>
            `).join('');
        } catch(e) { document.getElementById('franchise-container').innerHTML = '<p>Error loading franchises.</p>'; }
    };

    window.openNewFranchiseModal = () => {
        document.getElementById('f-id').value = "";
        fields.forEach(f => { document.getElementById('f-' + f).value = ""; });
        document.getElementById('f-status').value = "active";
        document.getElementById('modal-franchise').style.display = 'flex';
    };

    window.submitFranchise = async () => {
        const id = document.getElementById('f-id').value;
        const payload = {};
        fields.forEach(f => {
            const val = document.getElementById('f-' + f).value;
            payload[f] = (f === 'fee_paid') ? (parseFloat(val) || 0) : (val || null);
        });

        const res = await fetch(id ? `${F_API}/${id}` : F_API, {
            method: id ? 'PATCH' : 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            document.getElementById('modal-franchise').style.display = 'none';
            loadFranchises();
        } else { alert("Save Failed"); }
    };

    window.editFranchise = async (id) => {
        const res = await fetch(`${F_API}/${id}`);
        const f = await res.json();
        document.getElementById('f-id').value = f.id;
        fields.forEach(field => {
            document.getElementById('f-' + field).value = f[field] || "";
        });
        document.getElementById('modal-franchise').style.display = 'flex';
    };

    window.deleteFranchise = async (id) => {
        if(confirm("Delete this franchise?")) {
            await fetch(`${F_API}/${id}`, {method: 'DELETE'});
            loadFranchises();
        }
    };

    loadFranchises();
})();
</script>
