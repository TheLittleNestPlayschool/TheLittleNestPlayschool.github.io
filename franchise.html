<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0;">Franchise Manager</h1>
    <button onclick="openNewFranchiseModal()" style="background:#00d1b2; color:white; border:none; padding:12px 24px; cursor:pointer; font-weight:bold; border-radius:4px;">+ NEW FRANCHISE</button>
</div>

<div id="franchise-container" style="display: flex; flex-direction: column; gap: 20px;">
    <div style="text-align:center; padding:50px; border:1px solid #eee;">Syncing Franchise Data...</div>
</div>

<div id="modal-franchise" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:white; width:1000px; border-radius:8px; display:flex; flex-direction:column; max-height:95vh;">
        <div style="padding:20px; border-bottom:1px solid #eee; background:#f9f9f9;">
            <h3 style="margin:0;">Franchise Profile Editor</h3>
        </div>
        
        <div style="padding:25px; overflow-y:auto; flex-grow:1;">
            <input type="hidden" id="f-id">
            
            <h4 style="border-bottom:2px solid #00d1b2; padding-bottom:5px; margin-top:0;">1. Franchise & Brand Information</h4>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px;">
                <div style="grid-column: span 2;"><label>Franchise Name</label><input type="text" id="f-name" style="width:100%; padding:8px;"></div>
                <div><label>Status</label>
                    <select id="f-status" style="width:100%; padding:8px;">
                        <option value="active">active</option>
                        <option value="on_hold">on_hold</option>
                        <option value="closed">closed</option>
                        <option value="pending_opening">pending_opening</option>
                    </select>
                </div>
                <div style="grid-column: span 3;"><label>Full Address</label><input type="text" id="f-address" style="width:100%; padding:8px;"></div>
                <div><label>Main Phone</label><input type="text" id="f-phone_number" style="width:100%; padding:8px;"></div>
                <div><label>Franchise Email</label><input type="email" id="f-franchise_email" style="width:100%; padding:8px;"></div>
                <div><label>Royalty Rate (%)</label><input type="number" id="f-royalty_rate" step="0.01" style="width:100%; padding:8px;"></div>
                <div><label>Opening Date</label><input type="date" id="f-opening_date" style="width:100%; padding:8px;"></div>
                <div><label>Business Tax ID</label><input type="text" id="f-business_tax_id" style="width:100%; padding:8px;"></div>
                <div><label>Brand FB</label><input type="text" id="f-social_fb" style="width:100%; padding:8px;"></div>
                <div><label>Brand IG</label><input type="text" id="f-social_ig" style="width:100%; padding:8px;"></div>
                <div><label>Brand TikTok</label><input type="text" id="f-social_tiktok" style="width:100%; padding:8px;"></div>
                <div><label>Brand LinkedIn</label><input type="text" id="f-social_li" style="width:100%; padding:8px;"></div>
            </div>

            <h4 style="border-bottom:2px solid #00d1b2; padding-bottom:5px;">2. Owner 1 Details & Socials</h4>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px; background:#fcfcfc; padding:15px; border:1px solid #eee; border-radius:4px;">
                <div><label>Owner 1 Name</label><input type="text" id="f-owner_1_name" style="width:100%;"></div>
                <div><label>Owner 1 Phone</label><input type="text" id="f-owner_1_phone" style="width:100%;"></div>
                <div><label>Owner 1 Email</label><input type="email" id="f-owner_1_email" style="width:100%;"></div>
                <div><label>Owner 1 FB</label><input type="text" id="f-social_fb_1" style="width:100%;"></div>
                <div><label>Owner 1 IG</label><input type="text" id="f-social_ig_1" style="width:100%;"></div>
                <div><label>Owner 1 TikTok</label><input type="text" id="f-social_tiktok_1" style="width:100%;"></div>
                <div><label>Owner 1 LinkedIn</label><input type="text" id="f-social_li_1" style="width:100%;"></div>
            </div>

            <h4 style="border-bottom:2px solid #00d1b2; padding-bottom:5px;">3. Owner 2 Details & Socials</h4>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px; margin-bottom:25px; background:#fcfcfc; padding:15px; border:1px solid #eee; border-radius:4px;">
                <div><label>Owner 2 Name</label><input type="text" id="f-owner_2_name" style="width:100%;"></div>
                <div><label>Owner 2 Phone</label><input type="text" id="f-owner_2_phone" style="width:100%;"></div>
                <div><label>Owner 2 Email</label><input type="email" id="f-owner_2_email" style="width:100%;"></div>
                <div><label>Owner 2 FB</label><input type="text" id="f-social_fb_2" style="width:100%;"></div>
                <div><label>Owner 2 IG</label><input type="text" id="f-social_ig_2" style="width:100%;"></div>
                <div><label>Owner 2 TikTok</label><input type="text" id="f-social_tiktok_2" style="width:100%;"></div>
                <div><label>Owner 2 LinkedIn</label><input type="text" id="f-social_li_2" style="width:100%;"></div>
            </div>

            <div><label>Internal Notes</label><textarea id="f-internal_notes" style="width:100%; height:60px; padding:8px;"></textarea></div>
        </div>

        <div style="padding:20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px; background:#f9f9f9;">
            <button onclick="document.getElementById('modal-franchise').style.display='none'" style="padding:10px 20px; cursor:pointer; font-weight:bold; border-radius:4px;">CANCEL</button>
            <button onclick="submitFranchise()" style="background:#00d1b2; color:white; border:none; padding:10px 25px; cursor:pointer; font-weight:bold; border-radius:4px;">SAVE RECORD</button>
        </div>
    </div>
</div>

<script>
(function() {
    const F_API = 'https://x8ki-letl-twmt.n7.xano.io/api:mXEfdJlg/franchise';

    window.loadFranchises = async () => {
        try {
            const res = await fetch(F_API + '?t=' + Date.now());
            const data = await res.json();
            const list = Array.isArray(data) ? data : (data.items || []);
            
            document.getElementById('franchise-container').innerHTML = list.map(f => {
                const s = (val) => val ? '<span style="color:green;">✅</span>' : '<span style="color:red;">❌</span>';
                
                return `
                <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; border-bottom:2px solid #00d1b2; padding-bottom:10px; margin-bottom:10px;">
                        <h2 style="margin:0;">${f.name || 'N/A'}</h2>
                        <span style="font-weight:bold; color:#00d1b2; text-transform:uppercase;">${(f.status || '').replace('_',' ')}</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; font-size:0.85rem;">
                        <div>
                            <span style="color:#888; font-weight:bold; font-size:0.7rem;">FRANCHISE BRAND</span><br>
                            E: ${f.franchise_email || 'N/A'}<br>
                            P: ${f.phone_number || 'N/A'}<br>
                            Tax ID: ${f.business_tax_id || 'N/A'}<br>
                            FB: ${s(f.social_fb)} IG: ${s(f.social_ig)} TK: ${s(f.social_tiktok)} LI: ${s(f.social_li)}
                        </div>
                        <div>
                            <span style="color:#888; font-weight:bold; font-size:0.7rem;">OWNER 1: ${f.owner_1_name || 'N/A'}</span><br>
                            E: ${f.owner_1_email || 'N/A'}<br>
                            P: ${f.owner_1_phone || 'N/A'}<br>
                            FB: ${s(f.social_fb_1)} IG: ${s(f.social_ig_1)} TK: ${s(f.social_tiktok_1)} LI: ${s(f.social_li_1)}
                        </div>
                        <div>
                            <span style="color:#888; font-weight:bold; font-size:0.7rem;">OWNER 2: ${f.owner_2_name || 'N/A'}</span><br>
                            E: ${f.owner_2_email || 'N/A'}<br>
                            P: ${f.owner_2_phone || 'N/A'}<br>
                            FB: ${s(f.social_fb_2)} IG: ${s(f.social_ig_2)} TK: ${s(f.social_tiktok_2)} LI: ${s(f.social_li_2)}
                        </div>
                    </div>
                    <div style="margin-top:15px; padding-top:10px; border-top:1px solid #f9f9f9; font-size:0.8rem; color:#555;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                           <div><b>Address:</b> ${f.address || 'N/A'}</div>
                           <div><b>Royalty:</b> ${f.royalty_rate || '0'}% | <b>Opened:</b> ${f.opening_date || 'N/A'}</div>
                        </div>
                        <div style="margin-top:5px;"><b>Internal Notes:</b> ${f.internal_notes || 'None'}</div>
                    </div>
                    <div style="text-align:right; margin-top:15px;">
                        <button onclick="editFranchise(${f.id})" style="color:blue; border:1px solid blue; background:none; padding:5px 15px; cursor:pointer; font-weight:bold; border-radius:4px;">EDIT FULL RECORD</button>
                        <button onclick="deleteFranchise(${f.id})" style="color:red; border:1px solid red; background:none; padding:5px 15px; cursor:pointer; font-weight:bold; border-radius:4px; margin-left:5px;">DELETE</button>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { console.error(e); }
    };

    window.submitFranchise = async () => {
        const id = document.getElementById('f-id').value;
        const getV = (id) => document.getElementById(id).value || "";

        const payload = {
            name: getV('f-name'),
            status: getV('f-status'),
            address: getV('f-address'),
            phone_number: getV('f-phone_number'),
            franchise_email: getV('f-franchise_email'),
            royalty_rate: parseFloat(document.getElementById('f-royalty_rate').value) || 0,
            opening_date: getV('f-opening_date'),
            business_tax_id: getV('f-business_tax_id'),
            internal_notes: getV('f-internal_notes'),
            social_fb: getV('f-social_fb'),
            social_ig: getV('f-social_ig'),
            social_tiktok: getV('f-social_tiktok'),
            social_li: getV('f-social_li'),
            owner_1_name: getV('f-owner_1_name'),
            owner_1_phone: getV('f-owner_1_phone'),
            owner_1_email: getV('f-owner_1_email'),
            social_fb_1: getV('f-social_fb_1'),
            social_ig_1: getV('f-social_ig_1'),
            social_tiktok_1: getV('f-social_tiktok_1'),
            social_li_1: getV('f-social_li_1'),
            owner_2_name: getV('f-owner_2_name'),
            owner_2_phone: getV('f-owner_2_phone'),
            owner_2_email: getV('f-owner_2_email'),
            social_fb_2: getV('f-social_fb_2'),
            social_ig_2: getV('f-social_ig_2'),
            social_tiktok_2: getV('f-social_tiktok_2'),
            social_li_2: getV('f-social_li_2')
        };

        const method = id ? 'PATCH' : 'POST';
        const url = id ? `${F_API}/${id}` : F_API;

        try {
            const res = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                document.getElementById('modal-franchise').style.display = 'none';
                loadFranchises();
            } else {
                const err = await res.json();
                alert("Error: " + err.message);
            }
        } catch(err) {
            alert("Network Error. Check console.");
            console.error(err);
        }
    };

    window.editFranchise = async (id) => {
        const res = await fetch(`${F_API}/${id}`);
        const f = await res.json();
        const setV = (id, val) => document.getElementById(id).value = val || "";

        document.getElementById('f-id').value = f.id;
        setV('f-name', f.name);
        setV('f-status', f.status);
        setV('f-address', f.address);
        setV('f-phone_number', f.phone_number);
        setV('f-franchise_email', f.franchise_email);
        setV('f-royalty_rate', f.royalty_rate);
        setV('f-opening_date', f.opening_date);
        setV('f-business_tax_id', f.business_tax_id);
        setV('f-internal_notes', f.internal_notes);
        setV('f-social_fb', f.social_fb);
        setV('f-social_ig', f.social_ig);
        setV('f-social_tiktok', f.social_tiktok);
        setV('f-social_li', f.social_li);
        setV('f-owner_1_name', f.owner_1_name);
        setV('f-owner_1_phone', f.owner_1_phone);
        setV('f-owner_1_email', f.owner_1_email);
        setV('f-social_fb_1', f.social_fb_1);
        setV('f-social_ig_1', f.social_ig_1);
        setV('f-social_tiktok_1', f.social_tiktok_1);
        setV('f-social_li_1', f.social_li_1);
        setV('f-owner_2_name', f.owner_2_name);
        setV('f-owner_2_phone', f.owner_2_phone);
        setV('f-owner_2_email', f.owner_2_email);
        setV('f-social_fb_2', f.social_fb_2);
        setV('f-social_ig_2', f.social_ig_2);
        setV('f-social_tiktok_2', f.social_tiktok_2);
        setV('f-social_li_2', f.social_li_2);

        document.getElementById('modal-franchise').style.display = 'flex';
    };

    window.deleteFranchise = async (id) => {
        if(confirm("Are you sure you want to delete this franchise? This cannot be undone.")) {
            try {
                const res = await fetch(`${F_API}/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    loadFranchises();
                } else {
                    alert("Delete failed.");
                }
            } catch(err) {
                console.error(err);
            }
        }
    };

    window.openNewFranchiseModal = () => {
        document.getElementById('f-id').value = "";
        const inputs = document.querySelectorAll('#modal-franchise input, #modal-franchise textarea');
        inputs.forEach(i => i.value = "");
        document.getElementById('f-status').value = "active";
        document.getElementById('modal-franchise').style.display = 'flex';
    };

    loadFranchises();
})();
</script>
