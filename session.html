<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0;">Session Master List</h1>
    <button onclick="openNewSessionModal()" style="background:#00d1b2; color:white; border:none; padding:12px 25px; cursor:pointer; border-radius:4px; font-weight:900; letter-spacing:1px; box-shadow: 0 2px 4px rgba(0,209,178,0.3);">+ ADD NEW SESSION</button>
</div>

<div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; border: 1px solid #eee;">
    <span style="font-size: 0.75rem; font-weight: 800; color: #666; text-transform: uppercase;">Filter by Franchise:</span>
    <select id="franchise-filter" onchange="loadSessions()" style="padding: 8px 15px; border-radius: 4px; border: 1px solid #ddd; background: white; min-width: 250px; font-weight: bold;">
        <option value="all">Show All Franchises</option>
    </select>
</div>

<div id="session-container" style="display: flex; flex-direction: column; gap: 15px;">
    <div style="text-align:center; padding:50px; border:1px solid #eee; background:#fff;">Syncing Blueprint...</div>
</div>

<div id="modal-session" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:white; width:500px; border-radius:8px; display:flex; flex-direction:column; max-height:90vh; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <div style="padding:15px 20px; border-bottom:1px solid #eee; background:#1a1a1a; display:flex; justify-content:space-between; align-items:center;">
            <h2 id="modal-title" style="margin:0; font-size:1.1rem; color: #00d1b2;">Edit Session</h2>
            <button onclick="document.getElementById('modal-session').style.display='none'" style="cursor:pointer; border:none; background:#333; color: white; padding:5px 10px; border-radius:4px;">CLOSE</button>
        </div>
        <div id="modal-body-session" style="padding:20px; overflow-y:auto; flex-grow:1;">
            <input type="hidden" id="sess-id">
            
            <label style="display:block; font-size:0.7rem; font-weight:bold; color:#666; margin-bottom:5px;">SESSION NAME</label>
            <input type="text" id="sess-name" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px; box-sizing: border-box;">

            <label style="display:block; font-size:0.7rem; font-weight:bold; color:#666; margin-bottom:5px;">ASSIGNED FRANCHISE</label>
            <select id="sess-franchise-select" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px; background:white; box-sizing: border-box;">
                <option value="">Loading...</option>
            </select>

            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div style="flex:1;">
                    <label style="display:block; font-size:0.7rem; font-weight:bold; color:#666; margin-bottom:5px;">START TIME</label>
                    <input type="text" id="sess-start" placeholder="09:00 AM" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; box-sizing: border-box;">
                </div>
                <div style="flex:1;">
                    <label style="display:block; font-size:0.7rem; font-weight:bold; color:#666; margin-bottom:5px;">END TIME</label>
                    <input type="text" id="sess-end" placeholder="11:30 AM" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; box-sizing: border-box;">
                </div>
            </div>

            <label style="display:block; font-size:0.7rem; font-weight:bold; color:#666; margin-bottom:5px;">MAX STUDENTS</label>
            <input type="number" id="sess-max" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px; box-sizing: border-box;">

            <label style="display:block; font-size:0.7rem; font-weight:bold; color:#666; margin-bottom:5px;">SCHEDULED DAYS (Comma Separated)</label>
            <input type="text" id="sess-days" placeholder="Monday, Wednesday" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px; box-sizing: border-box;">

            <label style="display:block; font-size:0.7rem; font-weight:bold; color:#666; margin-bottom:5px;">DESCRIPTION</label>
            <textarea id="sess-desc" style="width:100%; padding:10px; height:60px; border:1px solid #ddd; border-radius:4px; margin-bottom:15px; box-sizing: border-box;"></textarea>

            <label style="display:flex; align-items:center; gap:10px; font-weight:bold; font-size:0.8rem; cursor:pointer;">
                <input type="checkbox" id="sess-active"> SESSION IS ACTIVE
            </label>
        </div>
        <div style="padding:15px 20px; border-top:1px solid #eee; background:#f9f9f9;">
            <button onclick="submitSession()" style="background:#00d1b2; color:white; border:none; padding:12px; cursor:pointer; font-weight:900; border-radius:4px; width:100%; letter-spacing:1px;">SAVE SESSION MASTER</button>
        </div>
    </div>
</div>

<script>
(function() {
    const S_API = 'https://x8ki-letl-twmt.n7.xano.io/api:mUsV7Zqx/session';
    const F_API = 'https://x8ki-letl-twmt.n7.xano.io/api:mXEfdJlg/franchise';
    let franchiseList = [];

    const fetchFranchises = async () => {
        try {
            const res = await fetch(F_API);
            const data = await res.json();
            franchiseList = Array.isArray(data) ? data : (data.items || []);
            
            const filterSelect = document.getElementById('franchise-filter');
            const editorSelect = document.getElementById('sess-franchise-select');
            
            const optionsHtml = franchiseList.map(f => `<option value="${f.id}">${f.location_name || f.name || 'Franchise ' + f.id}</option>`).join('');
            
            filterSelect.innerHTML = '<option value="all">Show All Franchises</option>' + optionsHtml;
            editorSelect.innerHTML = optionsHtml;
        } catch (e) { console.error("Error fetching franchises", e); }
    };

    window.loadSessions = async () => {
        const container = document.getElementById('session-container');
        const filterVal = document.getElementById('franchise-filter').value;
        
        try {
            const res = await fetch(S_API + '?t=' + Date.now());
            const data = await res.json();
            let list = Array.isArray(data) ? data : (data.items || []);

            // Apply Client-side filter
            if (filterVal !== 'all') {
                list = list.filter(s => s.franchise_id.toString() === filterVal);
            }

            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">No sessions found for this selection.</div>';
                return;
            }

            container.innerHTML = list.map(s => {
                const days = Array.isArray(s.scheduled_days) ? s.scheduled_days.join(', ') : (s.scheduled_days || 'None');
                const statusColor = s.is_active ? '#00d1b2' : '#ff4757';
                const franchise = franchiseList.find(f => f.id === s.franchise_id);
                const franchiseDisplay = franchise ? (franchise.location_name || franchise.name) : `ID: ${s.franchise_id}`;

                return `
                <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:18px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.05); border-left: 6px solid ${statusColor};">
                    <div style="flex: 2;">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                            <h3 style="margin:0; font-size:1.2rem; color:#1a1a1a;">${s.name}</h3>
                            <span style="font-size:0.7rem; font-weight:bold; background:#1a1a1a; color:#00d1b2; padding:3px 10px; border-radius:4px; text-transform:uppercase;">${franchiseDisplay}</span>
                        </div>
                        <p style="margin:0 0 10px 0; font-size:0.9rem; color:#666; font-style:italic;">${s.description || 'No description provided.'}</p>
                        <div style="display:flex; gap:20px; font-size:0.85rem; font-weight:bold; color:#444;">
                            <span style="background:#f0f0f0; padding:4px 8px; border-radius:4px;">üóì ${days}</span>
                            <span style="background:#f0f0f0; padding:4px 8px; border-radius:4px;">‚è∞ ${s.start_time_text} - ${s.end_time_text}</span>
                            <span style="background:#f0f0f0; padding:4px 8px; border-radius:4px;">üë• Max: ${s.max_students}</span>
                        </div>
                    </div>
                    <div style="display:flex; gap:12px;">
                        <button onclick="editSession(${s.id})" style="background:#1a1a1a; color:#00d1b2; border:2px solid #00d1b2; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:900; font-size:0.85rem; letter-spacing:1px; transition: 0.2s;">EDIT SESSION</button>
                        <button onclick="deleteSession(${s.id})" style="color:#ff4757; background:none; border:1px solid #ff4757; padding:10px 15px; border-radius:6px; cursor:pointer; font-size:0.8rem; font-weight:bold;">DEL</button>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { console.error(e); }
    };

    window.openNewSessionModal = () => {
        document.getElementById('modal-title').innerText = "Create New Session Master";
        document.getElementById('sess-id').value = "";
        document.getElementById('sess-name').value = "";
        document.getElementById('sess-franchise-select').value = franchiseList[0]?.id || "";
        document.getElementById('sess-start').value = "";
        document.getElementById('sess-end').value = "";
        document.getElementById('sess-max').value = "";
        document.getElementById('sess-days').value = "";
        document.getElementById('sess-desc').value = "";
        document.getElementById('sess-active').checked = true;
        document.getElementById('modal-session').style.display = 'flex';
    };

    window.editSession = async (id) => {
        const res = await fetch(`${S_API}/${id}`);
        const s = await res.json();
        document.getElementById('modal-title').innerText = "Update Session Blueprint";
        document.getElementById('sess-id').value = s.id;
        document.getElementById('sess-name').value = s.name;
        document.getElementById('sess-franchise-select').value = s.franchise_id;
        document.getElementById('sess-start').value = s.start_time_text;
        document.getElementById('sess-end').value = s.end_time_text;
        document.getElementById('sess-max').value = s.max_students;
        document.getElementById('sess-days').value = Array.isArray(s.scheduled_days) ? s.scheduled_days.join(', ') : s.scheduled_days;
        document.getElementById('sess-desc').value = s.description;
        document.getElementById('sess-active').checked = s.is_active;
        document.getElementById('modal-session').style.display = 'flex';
    };

    window.submitSession = async () => {
        const id = document.getElementById('sess-id').value;
        const daysInput = document.getElementById('sess-days').value;
        const payload = {
            name: document.getElementById('sess-name').value,
            franchise_id: parseInt(document.getElementById('sess-franchise-select').value),
            start_time_text: document.getElementById('sess-start').value,
            end_time_text: document.getElementById('sess-end').value,
            max_students: parseInt(document.getElementById('sess-max').value),
            scheduled_days: daysInput.split(',').map(d => d.trim()).filter(d => d !== ""),
            description: document.getElementById('sess-desc').value,
            is_active: document.getElementById('sess-active').checked
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${S_API}/${id}` : S_API;

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            document.getElementById('modal-session').style.display = 'none';
            loadSessions();
        }
    };

    window.deleteSession = async (id) => {
        if(confirm("Confirm deletion of this blueprint?")) {
            await fetch(`${S_API}/${id}`, { method: 'DELETE' });
            loadSessions();
        }
    };

    (async () => {
        await fetchFranchises();
        loadSessions();
    })();
})();
</script>
