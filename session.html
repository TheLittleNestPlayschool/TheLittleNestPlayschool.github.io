<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Session Manager - Integrated</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
:root{--max-width:1400px;--bg-main:#e8ffff;--bg-input:#ffeffb;--accent:#74e8e8;--accent-hover:#498787;}

body{
  font-family:Arial,Helvetica,sans-serif;
  margin:16px auto;
  padding:18px;
  max-width:var(--max-width);
  font-size:15px;
  background-color:var(--bg-main);
}

form .record-line{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-bottom:10px
}
.record-field{display:flex; flex-direction:column}

input,textarea,select{
  padding:8px;
  font-size:14px;
  box-sizing:border-box;
  background-color:var(--bg-input);
  border:1px solid #ccc;
  border-radius:4px;
  width:100%;
}

textarea{min-height:56px; resize:vertical}

button{
  padding:8px 12px;
  font-size:14px;
  background-color:var(--accent);
  border:none;
  border-radius:4px;
  cursor:pointer;
}
button:hover{background-color:var(--accent-hover); color:#fff;}

.controls{margin:12px 0}
#searchInput{
  width: 100%;
  padding:12px;
  font-size:15px;
  background-color:var(--bg-input);
  border:1px solid #ccc;
  border-radius:4px
}

#tableWrapper{
  max-height:600px;
  overflow-y:auto;
  border:1px solid #ddd;
  padding:8px;
  border-radius:6px;
  background:white;
}

table{width:100%; border-collapse:collapse; table-layout:fixed;}
th,td{border:1px solid #eee; padding:10px; vertical-align:top; font-size:13px; text-align:left;}
th{background:#f9f9f9; position: sticky; top: 0;}

.record-line-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:10px;
}

.record-field label{font-size:11px; font-weight:bold; margin-bottom:4px; color:#666;}

.actions button{display:block; width:100%; margin:4px 0;}

@media (max-width:1000px){
  form .record-line{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>

<body>

<h2>Add New Session</h2>
<form id="add-form" autocomplete="off">
  <div class="record-line">
    <div class="record-field"><label>Session Name</label><input id="name" required></div>
    <div class="record-field"><label>Franchise</label>
        <select id="franchise_id_select" required><option value="">Loading Franchises...</option></select>
    </div>
    <div class="record-field"><label>Teacher ID</label><input type="number" id="primary_teacher_id"></div>
    <div class="record-field"><label>Max Students</label><input type="number" id="max_students"></div>
  </div>

  <div class="record-line">
    <div class="record-field"><label>Start Time</label><input id="start_time_text" placeholder="09:00 AM"></div>
    <div class="record-field"><label>End Time</label><input id="end_time_text" placeholder="10:00 AM"></div>
    <div class="record-field"><label>Scheduled Days</label>
      <select id="scheduled_days" multiple style="height: 80px;">
        <option>Monday</option><option>Tuesday</option><option>Wednesday</option>
        <option>Thursday</option><option>Friday</option><option>Saturday</option><option>Sunday</option>
      </select>
    </div>
    <div class="record-field"><label>Status</label>
      <select id="is_active"><option value="true">Active</option><option value="false">Inactive</option></select>
    </div>
  </div>

  <div class="record-line">
    <div class="record-field" style="grid-column: span 4;"><label>Description</label><textarea id="description"></textarea></div>
  </div>

  <button type="submit" id="submitBtn">Create Session</button>
</form>

<div class="controls">
  <input id="searchInput" placeholder="Filter by session name, franchise, or teacher..." onkeyup="filterTable()" />
</div>

<div id="tableWrapper">
<table>
<thead>
<tr>
  <th style="width:60px">ID</th>
  <th>Session Details</th>
  <th style="width:100px">Actions</th>
</tr>
</thead>
<tbody id="table-body"></tbody>
</table>
</div>

<script>
const apiBase = "https://x8ki-letl-twmt.n7.xano.io/api:mUsV7Zqx/session";
const franchiseApi = "https://x8ki-letl-twmt.n7.xano.io/api:mUsV7Zqx/franchise"; // Inferred based on group ID

let allSessions = [];
let allFranchises = [];

// Initialize: Fetch Franchises then Sessions
async function init() {
    try {
        // 1. Fetch Franchises for the dropdowns
        const fRes = await fetch(franchiseApi);
        const fData = await fRes.json();
        allFranchises = Array.isArray(fData) ? fData : (fData.items || []);
        
        populateFranchiseDropdown();
        
        // 2. Fetch Sessions
        await fetchSessions();
    } catch (err) {
        console.error("Initialization Error:", err);
        document.getElementById('franchise_id_select').innerHTML = '<option>Error loading data</option>';
    }
}

function populateFranchiseDropdown() {
    const select = document.getElementById('franchise_id_select');
    select.innerHTML = '<option value="">-- Select Franchise --</option>';
    allFranchises.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.id;
        opt.textContent = f.name || `Franchise #${f.id}`;
        select.appendChild(opt);
    });
}

async function fetchSessions() {
    const res = await fetch(apiBase);
    const data = await res.json();
    allSessions = Array.isArray(data) ? data : (data.items || []);
    render();
}

function render() {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    
    allSessions.forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${s.id}</td>
            <td>
                <div class="record-line-grid">
                    <div class="record-field"><label>Name</label><input data-field="name" value="${s.name || ''}" disabled></div>
                    <div class="record-field"><label>Franchise</label>
                        <select data-field="franchise_id" disabled>
                            ${allFranchises.map(f => `<option value="${f.id}" ${f.id === s.franchise_id ? 'selected' : ''}>${f.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="record-field"><label>Start</label><input data-field="start_time_text" value="${s.start_time_text || ''}" disabled></div>
                    <div class="record-field"><label>End</label><input data-field="end_time_text" value="${s.end_time_text || ''}" disabled></div>
                    <div class="record-field"><label>Max</label><input type="number" data-field="max_students" value="${s.max_students || ''}" disabled></div>
                </div>
            </td>
            <td class="actions">
                <button onclick="editRow(this, ${s.id})">Edit</button>
                <button onclick="deleteRow(${s.id})" style="background:#ffcccc;">Del</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function editRow(btn, id) {
    const tr = btn.closest('tr');
    const fields = tr.querySelectorAll('input, select');
    
    if (btn.textContent === 'Edit') {
        fields.forEach(f => f.disabled = false);
        btn.textContent = 'Save';
        btn.style.background = '#ffd700';
    } else {
        const payload = {};
        fields.forEach(f => {
            const fieldName = f.dataset.field;
            payload[fieldName] = (f.type === 'number' || fieldName === 'franchise_id') ? parseInt(f.value) : f.value;
        });

        await fetch(`${apiBase}/${id}`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        btn.textContent = 'Edit';
        btn.style.background = '';
        fetchSessions();
    }
}

async function deleteRow(id) {
    if (!confirm('Permanently delete this session?')) return;
    await fetch(`${apiBase}/${id}`, { method: 'DELETE' });
    fetchSessions();
}

function filterTable() {
    const val = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#table-body tr');
    rows.forEach(r => {
        r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none';
    });
}

document.getElementById('add-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const payload = {
        name: document.getElementById('name').value,
        franchise_id: parseInt(document.getElementById('franchise_id_select').value),
        primary_teacher_id: parseInt(document.getElementById('primary_teacher_id').value) || null,
        max_students: parseInt(document.getElementById('max_students').value) || null,
        start_time_text: document.getElementById('start_time_text').value,
        end_time_text: document.getElementById('end_time_text').value,
        scheduled_days: Array.from(document.getElementById('scheduled_days').selectedOptions).map(o => o.value),
        description: document.getElementById('description').value,
        is_active: document.getElementById('is_active').value === 'true'
    };

    await fetch(apiBase, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });

    e.target.reset();
    btn.disabled = false;
    btn.textContent = 'Create Session';
    fetchSessions();
};

init();
</script>
</body>
</html>
