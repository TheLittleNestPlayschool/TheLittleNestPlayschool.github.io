<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Student</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 15px; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
</style>
</head>

<body>

<h2>New Student</h2>

<!-- FORM -->
<label>Student Name</label>
<input id="student_name" type="text">

<label>Student Age</label>
<input id="student_age" type="number">

<label>Select Parent</label>
<select id="parent_id">
    <option value="">Loading...</option>
</select>

<button onclick="saveStudent()">Save Student</button>

<hr>

<h3>Students List</h3>
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>Age</th>
            <th>Parent</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="student_list"></tbody>
</table>

<script>
const API = "https://x8ki-letl-twmt.n7.xano.io/api:iEHfqd-N";

// -------------------------------
// LOAD PARENTS INTO DROPDOWN
// -------------------------------
async function loadParents() {
    try {
        const res = await fetch(`${API}/parent`);
        const parents = await res.json();

        const select = document.getElementById("parent_id");
        select.innerHTML = "";

        parents.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.parent_name || ("Parent #" + p.id);
            select.appendChild(opt);
        });
    } catch (e) {
        alert("Error loading parents");
        console.log(e);
    }
}

// -------------------------------
// LOAD STUDENTS
// -------------------------------
async function loadStudents() {
    try {
        const res = await fetch(`${API}/student`);
        const students = await res.json();

        const tbody = document.getElementById("student_list");
        tbody.innerHTML = "";

        students.forEach(s => {
            const row = document.createElement("tr");

            row.innerHTML = `
                <td>${s.student_name}</td>
                <td>${s.student_age}</td>
                <td>${s.parent_name || "No Parent"}</td>
                <td>
                    <button onclick="editStudent(${s.id})">Edit</button>
                    <button onclick="deleteStudent(${s.id})" style="background:red;color:white;">Delete</button>
                </td>
            `;

            tbody.appendChild(row);
        });
    } catch (e) {
        alert("Error loading students");
        console.log(e);
    }
}

// -------------------------------
// SAVE STUDENT (CREATE)
// -------------------------------
async function saveStudent() {
    const data = {
        student_name: document.getElementById("student_name").value,
        student_age: Number(document.getElementById("student_age").value),
        parent_id: Number(document.getElementById("parent_id").value)
    };

    try {
        await fetch(`${API}/student`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        loadStudents();
        alert("Student saved!");

    } catch (e) {
        alert("Error saving student.");
        console.log(e);
    }
}

// -------------------------------
// DELETE STUDENT
// -------------------------------
async function deleteStudent(id) {
    if (!confirm("Delete this student?")) return;

    try {
        await fetch(`${API}/student/${id}`, { method: "DELETE" });
        loadStudents();
    } catch (e) {
        alert("Error deleting student");
        console.log(e);
    }
}

// -------------------------------
// EDIT STUDENT (LOAD INTO FORM)
// -------------------------------
async function editStudent(id) {
    try {
        const res = await fetch(`${API}/student/${id}`);
        const s = await res.json();

        document.getElementById("student_name").value = s.student_name;
        document.getElementById("student_age").value = s.student_age;
        document.getElementById("parent_id").value = s.parent_id;

        // Change save button to UPDATE mode
        const btn = document.querySelector("button");
        btn.textContent = "Update Student";
        btn.onclick = () => updateStudent(id);

    } catch (e) {
        alert("Error loading student");
        console.log(e);
    }
}

// -------------------------------
// UPDATE STUDENT
// -------------------------------
async function updateStudent(id) {
    const data = {
        student_name: document.getElementById("student_name").value,
        student_age: Number(document.getElementById("student_age").value),
        parent_id: Number(document.getElementById("parent_id").value)
    };

    try {
        await fetch(`${API}/student/${id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        alert("Updated!");
        loadStudents();

        // Reset button
        const btn = document.querySelector("button");
        btn.textContent = "Save Student";
        btn.onclick = saveStudent;

    } catch (e) {
        alert("Error updating student");
        console.log(e);
    }
}

// -------------------------------
// INIT
// -------------------------------
loadParents();
loadStudents();
</script>

</body>
</html>
