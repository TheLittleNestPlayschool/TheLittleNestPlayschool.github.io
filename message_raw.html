<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0;">Raw Message Log</h1>
</div>

<div style="display: flex; padding: 10px 20px; background: #f4f4f4; font-weight: bold; border-radius: 4px; margin-bottom: 10px; font-size: 0.85rem; color: #666;">
    <div style="flex: 1;">ID</div>
    <div style="flex: 2;">Sender</div>
    <div style="flex: 5;">Message Content</div>
    <div style="flex: 2;">Timestamp</div>
    <div style="width: 150px; text-align: right;">Actions</div>
</div>

<div id="raw-log-container" style="display: flex; flex-direction: column; gap: 5px;">
    <div style="text-align:center; padding:20px;">Loading raw logs...</div>
</div>

<div id="modal-raw" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:white; width:600px; border-radius:8px; padding:25px;">
        <h3>Edit Raw Message</h3>
        <input type="hidden" id="r-id">
        <div style="margin-bottom:15px;">
            <label>Message Content</label>
            <textarea id="r-message" style="width:100%; height:100px; padding:8px;"></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="document.getElementById('modal-raw').style.display='none'">CANCEL</button>
            <button onclick="submitRawEdit()" style="background:#00d1b2; color:white; border:none; padding:10px 20px; cursor:pointer; font-weight:bold;">SAVE CHANGES</button>
        </div>
    </div>
</div>

<script>
(function() {
    const RAW_API = 'https://x8ki-letl-twmt.n7.xano.io/api:mXEfdJlg/message_raw';

    window.loadRawLogs = async () => {
        try {
            const res = await fetch(RAW_API + '?t=' + Date.now());
            const data = await res.json();
            let list = Array.isArray(data) ? data : (data.items || []);
            
            // Keeping order stable
            list.sort((a, b) => b.id - a.id);

            document.getElementById('raw-log-container').innerHTML = list.map(r => `
                <div style="display: flex; align-items: center; padding: 8px 20px; background: #fff; border: 1px solid #eee; border-radius: 4px; font-size: 0.85rem; transition: background 0.2s;" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='#fff'">
                    <div style="flex: 1; color: #888;">#${r.id}</div>
                    <div style="flex: 2; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 10px;">${r.sender_name || 'Unknown'}</div>
                    <div style="flex: 5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 15px; color: #444;">${r.message || ''}</div>
                    <div style="flex: 2; color: #999; font-size: 0.75rem;">${new Date(r.created_at).toLocaleString()}</div>
                    <div style="width: 150px; text-align: right; display: flex; justify-content: flex-end; gap: 8px;">
                        <button onclick="editRaw(${r.id})" style="color: blue; background: none; border: 1px solid blue; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 0.75rem;">EDIT</button>
                        <button onclick="deleteRaw(${r.id})" style="color: red; background: none; border: 1px solid red; padding: 2px 8px; cursor: pointer; border-radius: 3px; font-size: 0.75rem;">DELETE</button>
                    </div>
                </div>
            `).join('');
        } catch(e) { console.error("Raw log load failed", e); }
    };

    window.submitRawEdit = async () => {
        const id = document.getElementById('r-id').value;
        const payload = {
            message: document.getElementById('r-message').value
        };

        // Applying the PUT method logic that worked for Franchise/Teacher
        const res = await fetch(`${RAW_API}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            document.getElementById('modal-raw').style.display = 'none';
            loadRawLogs();
        } else {
            alert("Update failed.");
        }
    };

    window.editRaw = async (id) => {
        const res = await fetch(`${RAW_API}/${id}`);
        const r = await res.json();
        document.getElementById('r-id').value = r.id;
        document.getElementById('r-message').value = r.message || "";
        document.getElementById('modal-raw').style.display = 'flex';
    };

    window.deleteRaw = async (id) => {
        if(confirm("Delete this raw log entry?")) {
            await fetch(`${RAW_API}/${id}`, { method: 'DELETE' });
            loadRawLogs();
        }
    };

    loadRawLogs();
})();
</script>
