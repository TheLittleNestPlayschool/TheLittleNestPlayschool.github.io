<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h1 style="margin:0;">Raw Message Log</h1>
    <button onclick="loadRawLogs()" style="background:#00d1b2; color:white; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; border-radius:4px;">RELOAD LOGS</button>
</div>

<div style="display: flex; padding: 12px 20px; background: #f4f4f4; font-weight: bold; border-radius: 4px; margin-bottom: 5px; font-size: 0.75rem; color: #666; border: 1px solid #eee;">
    <div style="width: 50px;">ID</div>
    <div style="width: 160px;">Created At</div>
    <div style="width: 140px;">Sender Ext ID</div>
    <div style="width: 80px;">Direction</div>
    <div style="width: 140px;">Received At</div>
    <div style="width: 100px;">First Name</div>
    <div style="width: 100px;">Last Name</div>
    <div style="width: 80px; text-align: center;">Proc?</div>
    <div style="width: 80px; text-align: center;">Enrich?</div>
    <div style="flex-grow: 1; text-align: right;">Actions</div>
</div>

<div id="raw-log-container" style="display: flex; flex-direction: column; gap: 8px;">
    <div style="text-align:center; padding:40px; color:#888;">Syncing all 13 fields...</div>
</div>

<div id="modal-raw" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:white; width:600px; border-radius:8px; padding:25px;">
        <h3 style="margin-top:0;">Edit Raw Message Record</h3>
        <input type="hidden" id="r-id">
        <div style="margin-bottom:20px;">
            <label style="display:block; margin-bottom:8px; font-weight:bold;">Payload Content</label>
            <textarea id="r-payload" style="width:100%; height:200px; padding:12px; border:1px solid #ccc; border-radius:4px; font-family:inherit;"></textarea>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="document.getElementById('modal-raw').style.display='none'">CANCEL</button>
            <button onclick="submitRawEdit()" style="background:#00d1b2; color:white; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; border-radius:4px;">SAVE RECORD</button>
        </div>
    </div>
</div>

<script>
(function() {
    const RAW_API = 'https://x8ki-letl-twmt.n7.xano.io/api:dnPQr9P8/message_raw';

    window.loadRawLogs = async () => {
        const container = document.getElementById('raw-log-container');
        try {
            const res = await fetch(RAW_API + '?t=' + Date.now());
            const data = await res.json();
            let list = Array.isArray(data) ? data : (data.items || []);
            
            if (list.length === 0) {
                container.innerHTML = '<div style="padding:20px; border:1px solid #eee; background:white;">No records found.</div>';
                return;
            }

            list.sort((a, b) => b.id - a.id);

            container.innerHTML = list.map(r => {
                const check = (val) => val === true ? '✅' : '❌';
                const dateFmt = (d) => d ? new Date(d).toLocaleString([], {year:'numeric', month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '---';

                return `
                <div style="background: #fff; border: 1px solid #eee; border-radius: 4px; padding: 10px 20px; font-size: 0.8rem;">
                    <div style="display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f9f9f9; padding-bottom: 5px;">
                        <div style="width: 50px; font-family: monospace; font-weight:bold; color:#aaa;">${r.id}</div>
                        <div style="width: 160px;">${dateFmt(r.created_at)}</div>
                        <div style="width: 140px; color:#666;">${r.sender_external_id || '---'}</div>
                        <div style="width: 80px;">${r.direction || '---'}</div>
                        <div style="width: 140px;">${dateFmt(r.received_at)}</div>
                        <div style="width: 100px; font-weight:bold;">${r.first_name || ''}</div>
                        <div style="width: 100px; font-weight:bold;">${r.last_name || ''}</div>
                        <div style="width: 80px; text-align: center;">${check(r.is_processed)}</div>
                        <div style="width: 80px; text-align: center;">${check(r.is_enriched)}</div>
                        <div style="flex-grow: 1; text-align: right;">
                            <button onclick="editRaw(${r.id})" style="color: #00d1b2; background: none; border: 1px solid #00d1b2; padding: 2px 8px; cursor: pointer; border-radius: 4px; font-size: 0.7rem; font-weight:bold;">EDIT</button>
                            <button onclick="deleteRaw(${r.id})" style="color: #ff4757; background: none; border: 1px solid #ff4757; padding: 2px 8px; cursor: pointer; border-radius: 4px; font-size: 0.7rem; font-weight:bold; margin-left: 5px;">DEL</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 20px; align-items: center; color: #555;">
                        <div style="flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: #fcfcfc; padding: 4px 8px; border-radius: 3px; border: 1px solid #f0f0f0;">
                            <span style="font-weight:bold; color:#888; font-size:0.7rem; margin-right:5px;">PAYLOAD:</span> ${r.payload || '---'}
                        </div>
                        <div style="width: 250px; font-size: 0.7rem; color: #007bff; overflow: hidden; text-overflow: ellipsis;">
                            <span style="font-weight:bold; color:#888;">PIC:</span> ${r.profile_pic || '---'}
                        </div>
                        <div style="width: 150px; font-size: 0.75rem;">
                            <span style="font-weight:bold; color:#888;">CONV:</span> ${r.conversation_id || '---'}
                        </div>
                        <div style="width: 150px; font-size: 0.75rem; color: ${r.ai_error ? 'red' : '#999'};">
                            <span style="font-weight:bold; color:#888;">AI ERR:</span> ${r.ai_error || 'None'}
                        </div>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { 
            container.innerHTML = '<div style="color:red; padding:20px;">Connection failed with dnPQr9P8 endpoint.</div>';
        }
    };

    window.submitRawEdit = async () => {
        const id = document.getElementById('r-id').value;
        const payload = { payload: document.getElementById('r-payload').value };
        const res = await fetch(`${RAW_API}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if (res.ok) { document.getElementById('modal-raw').style.display = 'none'; loadRawLogs(); }
    };

    window.editRaw = async (id) => {
        const res = await fetch(`${RAW_API}/${id}`);
        const r = await res.json();
        document.getElementById('r-id').value = r.id;
        document.getElementById('r-payload').value = r.payload || "";
        document.getElementById('modal-raw').style.display = 'flex';
    };

    window.deleteRaw = async (id) => {
        if(confirm("Delete record #" + id + "?")) {
            await fetch(`${RAW_API}/${id}`, { method: 'DELETE' });
            loadRawLogs();
        }
    };

    loadRawLogs();
})();
</script>
